

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="一个几乎百搭、不改架构、低成本就能落地的整车防重放方案，不是什么颠覆性创新，但或许能给大家带来一点启发">
<meta property="og:type" content="article">
<meta property="og:title" content="利用影子认证帧在标准CAN上实现防重放的技术方案">
<meta property="og:url" content="http://novysodope.github.io/2025/08/31/117/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="一个几乎百搭、不改架构、低成本就能落地的整车防重放方案，不是什么颠覆性创新，但或许能给大家带来一点启发">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/2025/08/31/117/images/117/Ryx7-nJ9UwGhZbyQKTVrDEP_BSAuivKO9NOSdjCe2EA.png">
<meta property="og:image" content="http://novysodope.github.io/2025/08/31/117/images/117/GNFlkRJklKbj5jQ3zR9uM33yfu9AFI3LFScKkiV3KOs.png">
<meta property="og:image" content="http://novysodope.github.io/2025/08/31/117/images/117/pz1BM8JDwUL5aJbYLmdZBV7fTddax8qKoYxSeHQMHEE.png">
<meta property="og:image" content="http://novysodope.github.io/2025/08/31/117/images/117/wy6LvdxDymo4TIyLJ1Xv2PgeldopjjXz3fkX9Tvxn6o.png">
<meta property="og:image" content="http://novysodope.github.io/2025/08/31/117/images/117/P4iFQ1mqCnSGZfjhbHGLyBMqqVU3uplI0dbMS58Fgzg.png">
<meta property="article:published_time" content="2025-08-31T02:13:21.000Z">
<meta property="article:modified_time" content="2025-09-05T03:20:18.686Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="车联网">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/2025/08/31/117/images/117/Ryx7-nJ9UwGhZbyQKTVrDEP_BSAuivKO9NOSdjCe2EA.png">
  
  <title>利用影子认证帧在标准CAN上实现防重放的技术方案 - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ZyJbAKYmfgJXZGNkDKKBRC0i-gzGzoHsz","app_key":"WXTmIgfHD2JkbhooWMtgYW3C","server_url":"https://zyjbakym.lc-cn-n1-shared.com","path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/rss2.xml" title="novy's Blog" type="application/rss+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/rss2.xml">
                <i class="iconfont icon-rss-fill"></i>
                RSS
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/POC.html">
                
                test
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="利用影子认证帧在标准CAN上实现防重放的技术方案">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-08-31 10:13" pubdate>
        August 31, 2025 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.5k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      17 分钟
    </span>
  

  
  
    

      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">利用影子认证帧在标准CAN上实现防重放的技术方案</h1>
            
            <div class="markdown-body">
              <p>一个几乎百搭、不改架构、低成本就能落地的整车防重放方案，不是什么颠覆性创新，但或许能给大家带来一点启发：</p>
<figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Plain">把原来单独的业务指令（业务帧）变成一个 “指令+动态密码” 的组合，这个 “动态密码” 被打包在一个单独的帧里，这里称为认证帧。因为认证帧和指令帧绑定且紧随其后，就像影子一样，所以这里就叫它 “影子认证帧”<br></code></pre></div></td></tr></table></figure>
<p>也就是说，要实现该方案只需要给每一个关键控制帧后面额外增加一帧即可。如果觉得单纯计数器不够安全、本身没有用CANFD、想低成本短时间满足要求的可以参考本文。下面，给大家解析这个方案该如何开展</p>
<h2 id="确定保护范围"><a href="#确定保护范围" class="headerlink" title="确定保护范围"></a>确定保护范围</h2><p>因为方案是基于“<strong>庞大的整车电子电气架构牵一发而动全身，改造起来成本高昂、协同困难或没有多余的数据场位做校验</strong>”的原因考虑，所以在开始实施的阶段，我们只需要筛选出一些需要防重放的报文，而不是所有：</p>
<ul>
<li>识别网络中所有需要防重放保护的关键控制功能（可以根据TARA也可以自己凭经验列举）</li>
<li>列出这些关键帧的CAN ID清单</li>
</ul>
<h2 id="影子认证帧ID分配规则"><a href="#影子认证帧ID分配规则" class="headerlink" title="影子认证帧ID分配规则"></a>影子认证帧ID分配规则</h2><p>筛选出清单后，需要为清单中的每一个关键帧CAN ID (<code>x</code>) 分配一个唯一的影子认证帧CAN ID (<code>x&#39;</code>)</p>
<p><strong>分配规则</strong>：<code>x&#39; = x + Base_Numb</code>（例如，<code>Base_Numb = 0x100</code>），或根据预定义的映射表进行分配</p>
<p><strong>前置条件</strong>：必须确保所有分配的 <code>x&#39;</code> 不与网络中任何现有帧ID发生冲突，需要查询整车CAN矩阵进行确认</p>
<p><strong>示例：</strong>需要做防重放的关键帧ID为<code>0x100</code>，那么根据前面分配规则说到的公式<code>0x100 + 0x100 = 0x200</code>，分配的影子认证帧ID就为<code>0x200</code></p>
<h2 id="影子认证帧数据结构"><a href="#影子认证帧数据结构" class="headerlink" title="影子认证帧数据结构"></a>影子认证帧数据结构</h2><p>参照标准CAN格式，统一影子认证帧的数据场格式为8字节，具体定义如下：</p>
<table>
<thead>
<tr>
<th><strong>字节索引</strong></th>
<th><strong>字段名称</strong></th>
<th><strong>长度</strong></th>
<th><strong>值/描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>计数器<br>(<code>ctr</code>)</td>
<td>1 Byte</td>
<td>单调递增的计数值，范围<code>0x00\~0xFF（0-255）</code>，发送后递增</td>
</tr>
<tr>
<td>1</td>
<td>认证标签高字节<br>(<code>Tag_H</code>)</td>
<td>1 Byte</td>
<td>由CMAC算法生成的16位认证标签的高位字节</td>
</tr>
<tr>
<td>2</td>
<td>认证标签低字节<br>(<code>Tag_L</code>)</td>
<td>1 Byte</td>
<td>由CMAC算法生成的16位认证标签的低位字节</td>
</tr>
<tr>
<td>3-7</td>
<td>时间戳/状态<br>(<code>Time_Stamp</code>)</td>
<td>N Byte</td>
<td>用于同步或增强防回滚能力的时间片或状态字，剩余可填充0xAA</td>
</tr>
</tbody></table>
<h2 id="算法和密钥管理"><a href="#算法和密钥管理" class="headerlink" title="算法和密钥管理"></a>算法和密钥管理</h2><ul>
<li>为了方便管理，统一加密算法为AES128-CMAC（或其他算法）</li>
<li>为所有关键帧ID(<code>x</code>)分配一个统一的加密密钥(<code>key</code>) //实际上应该是为每一个关键帧ID单独分配密钥更安全，但考虑到大多数不想这么麻烦，所以可以改成统一密钥</li>
<li>通过安全刷写将密钥 (<code>key</code>) 写入发送ECU和接收ECU的安全存储中，如果没有条件存储，可以将密钥编码在固件中</li>
</ul>
<h2 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h2><h3 id="发送端ECU实现"><a href="#发送端ECU实现" class="headerlink" title="发送端ECU实现"></a>发送端ECU实现</h3><p>发送端需要在原有发送流程中集成以下步骤：</p>
<ol>
<li><p>当应用层请求发送受保护的关键帧(<code>s</code>)时，获取当前计数器值(<code>ctr</code>)以及当前时间片 <code>Time_Stamp</code></p>
</li>
<li><p>构造CMAC计算所需的输入数据：<code>Input = s.ID (2B) || s.DATA (8B) || ctr (1B) || Time_Stamp (1B)</code> //此处时间戳假设为1个字节，如果不够，根据情况扩充</p>
</li>
<li><p>使用密钥(<code>key</code>)计算CMAC：<code>Full_Tag = CMAC(key, Input)</code></p>
</li>
<li><p>截取<code>Full_Tag</code>的前16个比特位作为本次发送的认证标签(<code>Tag16</code>) //2个字节，填充高低位</p>
</li>
<li><p>先发送业务帧(<code>s</code>)</p>
</li>
<li><p>然后发送影子认证帧(<code>x&#39;</code>)，数据场按数据结构的定义格式填充：</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp">[<span class="hljs-meta">ctr, Tag_H, Tag_L, Time_Stamp, 0xAA, 0xAA, 0xAA, 0xAA</span>]<br></code></pre></div></td></tr></table></figure>
<ol start="7">
<li>发送成功后，更新计数器(<code>ctr</code>)</li>
</ol>
<h4 id="逻辑流程图如下"><a href="#逻辑流程图如下" class="headerlink" title="逻辑流程图如下"></a>逻辑流程图如下</h4><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs graphql">graph TD<br>    A[开始发送] --&gt; B[获取ctr和Time_Stamp]<br>    B --&gt; C[构造CMAC输入数据]<br>    C --&gt; D[计算并截取Tag16]<br>    D --&gt; E[发送业务帧s]<br>    E --&gt; F[发送影子认证帧x&#39;]<br>    F --&gt; G[更新计数器]<br>    G --&gt; H[结束]<br></code></pre></div></td></tr></table></figure>
<p><img src="images/117/Ryx7-nJ9UwGhZbyQKTVrDEP_BSAuivKO9NOSdjCe2EA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h3 id="接收端ECU实现"><a href="#接收端ECU实现" class="headerlink" title="接收端ECU实现"></a>接收端ECU实现</h3><ol>
<li>接收端需要实现一个新的验证状态机制：</li>
<li>当收到业务帧(<code>s</code>)时，将其数据副本与接收时间戳存入缓存池，并暂停该帧的应用层处理</li>
<li>启动一个定时器（根据业务和网络负载调整），等待对应的影子认证帧(<code>x&#39;</code>)</li>
<li>超时处理：若超时仍未收到(<code>x&#39;</code>)，则从缓存中丢弃该业务帧(<code>s</code>)，不再处理</li>
<li>若收到影子认证帧(<code>x&#39;</code>)：</li>
</ol>
<p><strong>a.</strong> 从缓存中查找与之匹配的业务帧(<code>s</code>)<br><strong>b.</strong> 从(<code>x&#39;</code>)数据场中提取 <code>ctr_recv</code> 和 <code>Tag16_recv</code>以及<code>Time_Stamp_recv</code><br><strong>c.</strong> 使用密钥 (<code>key</code>)、缓存的<code>s.ID</code>、<code>s.DATA</code> 以及提取的 <code>ctr_recv</code>、<code>Time_Stamp_recv</code>，按照发送流程重新计算期望的认证标签(<code>Tag16_calc</code>)<br><strong>d.</strong> 计算输入：<code>Input_calc = s.ID (2B) || s.DATA (8B) || ctr_recv (1B) || Time_Stamp_recv (1B)</code><br><strong>e.</strong> 计算：<code>Tag16_calc = Truncate(CMAC(key, Input_calc), 16)</code> //截断取前两个字节用作高低位<br><strong>f.</strong> 验证对比：</p>
<ul>
<li>若 <code>Tag16_calc != Tag16_recv</code>，验证失败，丢弃业务帧(<code>s</code>)，不再处理</li>
<li>若 <code>Tag16_calc == Tag16_recv</code>，进行<code>Time_Stamp</code>有效性校验和计数器防重放检查</li>
</ul>
<ol start="6">
<li>清除缓存中对应的业务帧(<code>s</code>)</li>
<li>更新计数器</li>
</ol>
<h4 id="逻辑流程图如下-1"><a href="#逻辑流程图如下-1" class="headerlink" title="逻辑流程图如下"></a>逻辑流程图如下</h4><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs graphql">graph TD<br>    A[收到业务帧s] --&gt; B&#123;帧s.ID是否在&lt;br&gt;受保护列表?&#125;<br>    B -- 否 --&gt; C[提交应用层处理]<br>    B -- 是 --&gt; D[缓存s.ID与s.DATA&lt;br&gt;启动超时定时器]<br>    <br>    D --&gt; E&#123;在超时时间内&lt;br&gt;收到影子认证帧x&#39;?&#125;<br>    E -- 否 --&gt; F[丢弃缓存帧s&lt;br&gt;（可选项）：触发超时告警]<br>    <br>    E -- 是 --&gt; G[提取ctr_recv, Tag16_recv, Time_Stamp_recv]<br>    G --&gt; H[根据缓存数据计算&lt;br&gt;Tag16_calc]<br>    H --&gt; I&#123;Tag16_calc &#x3D;&#x3D;&lt;br&gt;Tag16_recv?&#125;<br>    I -- 否 --&gt; J[认证失败&lt;br&gt;丢弃帧s]<br>    <br>    I -- 是 --&gt; K&#123;Time_Stamp_recv有效?&lt;br&gt;（等于或接近My_Time_Stamp）&#125;<br>    K -- 否 --&gt; L[时间片无效→重放攻击&lt;br&gt;丢弃帧s]<br>    <br>    K -- 是 --&gt; M&#123;ctr_recv有效?&lt;br&gt;（在预期狭小窗口内）&#125;<br>    M -- 否 --&gt; N[计数器无效→重放攻击&lt;br&gt;丢弃帧s]<br>    <br>    M -- 是 --&gt; O[验证成功]<br>    O --&gt; P[提交业务帧s至应用层]<br>    O --&gt; Q[更新last_valid_ctr &#x3D; ctr_recv]<br>    <br>    J --&gt; R[结束]<br>    L --&gt; R<br>    N --&gt; R<br>    P --&gt; R<br>    Q --&gt; R<br>    <br>    subgraph 接收端统一清理<br>        R[清除缓存中本帧记录]<br>    end<br></code></pre></div></td></tr></table></figure>
<p><img src="images/117/GNFlkRJklKbj5jQ3zR9uM33yfu9AFI3LFScKkiV3KOs.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h4 id="发送端："><a href="#发送端：" class="headerlink" title="发送端："></a>发送端：</h4><p>场景： <code>100</code></p>
<ol>
<li>业务帧(<code>s</code>)：</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp">s.ID = <span class="hljs-number">0x100</span><br>s.DATA = [<span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]<br></code></pre></div></td></tr></table></figure>
<ol start="2">
<li>获取静态配置：</li>
</ol>
<ul>
<li>密钥 <code>key = 0xsecretkey</code></li>
<li>影子认证帧ID <code>x&#39; = 0x200</code></li>
<li>当前计数器 <code>ctr = 0x0B</code></li>
<li>当前时间片 <code>Time_Stamp = 0x03</code></li>
</ul>
<ol start="3">
<li>执行流程：</li>
</ol>
<p><strong>a.</strong> 拼接 Input： <code>0x100 + [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00] + 0x0B + 0x03</code><br><strong>b.</strong> 用 <code>key </code>计算 <code>Input </code>的<code>CMAC</code>，得到 <code>Tag16</code><br><strong>c.</strong> 发送第一帧（业务帧）：</p>
<figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp">ID=<span class="hljs-number">0x100</span>, Data=[<span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]<br></code></pre></div></td></tr></table></figure>
<p><strong>d.</strong> 发送第二帧（认证帧）：</p>
<figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp">ID=<span class="hljs-number">0x200</span>, Data=[<span class="hljs-number">0x0B</span>, Tag_H, Tag_L, <span class="hljs-number">0x03</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0xAA</span>]<br></code></pre></div></td></tr></table></figure>
<p><strong>e.</strong> 将 <code>0x100</code> 对应的计数器加一，变为 <code>0x0C</code></p>
<h5 id="发送端示例流程图"><a href="#发送端示例流程图" class="headerlink" title="发送端示例流程图"></a>发送端示例流程图</h5><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs graphql">flowchart TD<br>    A[应用层请求发送关键帧s] --&gt; B[获取ctr和Time_Stamp]<br>    B --&gt; C[构造输入数据: Input &#x3D; s.ID + s.DATA + ctr + Time_Stamp]<br>    C --&gt; D[计算Full_Tag &#x3D; CMACkey, Input]<br>    D --&gt; E[截取Tag16 &#x3D; 前16位]<br>    E --&gt; F[发送业务帧s]<br>    F --&gt; G[发送影子认证帧x&#39;&lt;br&gt;数据: ctr, Tag_H, Tag_L, Time_Stamp, 填充]<br>    G --&gt; H[更新计数器: ctr &#x3D; ctr + 1]<br>    H --&gt; I[发送完成]<br><br>    subgraph 示例配置<br>        J[帧ID: 0x100]<br>        K[数据: 0100000000000000]<br>        L[计数器: 0x0B]<br>        M[时间片: 0x03]<br>        N[影子认证帧ID: 0x200]<br>        O[密钥: 0xsecretkey]<br>    end<br></code></pre></div></td></tr></table></figure>
<p><img src="images/117/pz1BM8JDwUL5aJbYLmdZBV7fTddax8qKoYxSeHQMHEE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h4 id="接收端："><a href="#接收端：" class="headerlink" title="接收端："></a>接收端：</h4><p>接收端自身维护一个当前的有效时间片值<code>My_Time_Stamp</code>（比如由网关同步或根据自身系统时间计算得出）和为每个发送源（或每个帧ID）维护一个最后有效的计数器值(<code>last_valid_ctr</code>)</p>
<p>校验流程：</p>
<ol>
<li>总线收到一帧：<code>ID=0x100, Data=[0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]</code></li>
</ol>
<p><strong>a.接收端逻辑</strong>：这是受保护的关键帧<code>s</code>，我需要等待它的影子认证帧进行验证<br><strong>b.动作</strong>：将这份数据<code>s.ID</code> 和 <code>s.DATA</code> 存入缓存池，并暂停对该帧的应用层处理，启动一个定时器（例如200ms）<br>2. 总线收到下一帧：<code>ID=0x200, Data=[0x0B, Tag_H, Tag_L, 0x03, 0xAA, 0xAA, 0xAA, 0xAA]</code><br><strong>a.接收端逻辑</strong>：这是我正在等待对应 <code>0x100</code> 的影子认证帧<br><strong>b.动作：</strong><br>1）从缓存中查找影子认证帧对应的<code>ID=0x100</code>业务帧数据<br>2）从影子认证帧数据场中提取：</p>
<figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp">* ctr_recv = <span class="hljs-number">0x0B</span><br>* Tag16_recv = <span class="hljs-number">0x0102</span> (高字节<span class="hljs-number">0x01</span> + 低字节<span class="hljs-number">0x02</span>) <span class="hljs-comment">//Tag_H、Tag_L，此处假设是0102</span><br>* Time_Stamp_recv = <span class="hljs-number">0x03</span><br></code></pre></div></td></tr></table></figure>
<ol start="3">
<li>接收端开始重现发送端的计算过程：</li>
</ol>
<p><strong>a.</strong> <code>Input_calc = s.ID (2B) || s.DATA (8B) || ctr_recv (1B) || Time_Stamp_recv (1B) //拼接输入</code><br><strong>b.</strong> <code>Full_Tag_calc = CMAC(key, Input_calc) //计算CMAC</code><br><strong>c.</strong> <code>Tag16_calc = Truncate(Full_Tag_calc, 16) //取前两个字节</code><br>4. 比较 <code>Tag16_calc (0x0102)</code> 和 <code>Tag16_recv (0x0102)</code>，通过则下一步，不通过丢弃<br>5. 检查时间片：比较<code>Time_Stamp_recv</code>和接收端自己的<code>My_Time_Stamp</code>，通过则下一步，不通过丢弃<br>6. 检查计数器：接收端预期下一个计数器是 <code>0x0B</code>，收到的<code>ctr_recv</code>是<code>0x0B</code>，通过则执行动作，不通过丢弃<br>7. 更新 <code>last_valid_ctr = ctr_recv</code></p>
<h5 id="接收示例流程图"><a href="#接收示例流程图" class="headerlink" title="接收示例流程图"></a>接收示例流程图</h5><figure class="highlight plain"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs graphql">flowchart TD<br>    A[收到业务帧s] --&gt; B&#123;受保护帧?&#125;<br>    B -- 否 --&gt; C[提交应用层]<br>    B -- 是 --&gt; D[缓存数据并启动定时器]<br>    D --&gt; E&#123;收到影子认证帧?&#125;<br>    E -- 超时 --&gt; F[丢弃帧s]<br>    E -- 收到 --&gt; G[提取ctr_recv, Tag16_recv, Time_Stamp_recv]<br>    G --&gt; H[计算Tag16_calc]<br>    H --&gt; I&#123;标签验证?&#125;<br>    I -- 失败 --&gt; J[认证失败→丢弃]<br>    I -- 成功 --&gt; K&#123;时间片有效?&#125;<br>    K -- 无效 --&gt; L[时间片无效→丢弃]<br>    K -- 有效 --&gt; M&#123;计数器有效?&#125;<br>    M -- 无效 --&gt; N[计数器无效→丢弃]<br>    M -- 有效 --&gt; O[验证成功]<br>    O --&gt; P[提交应用层]<br>    O --&gt; Q[更新last_valid_ctr]<br>    F --&gt; R[清理缓存]<br>    J --&gt; R<br>    L --&gt; R<br>    N --&gt; R<br>    P --&gt; R<br>    Q --&gt; R<br>    subgraph 示例数据<br>        S[业务帧: ID&#x3D;0x100, Data&#x3D;0100000000000000]<br>        T[影子认证帧: ID&#x3D;0x200, Data&#x3D;0B010203AAAAAAAA]<br>        U[提取: ctr&#x3D;0x0B, Time_Stamp&#x3D;0x03]<br>    end<br></code></pre></div></td></tr></table></figure>
<p><img src="images/117/wy6LvdxDymo4TIyLJ1Xv2PgeldopjjXz3fkX9Tvxn6o.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本方案结合了之前的项目，有成功落地的案例，并在此基础上做了优化，后面可以根据自身情况更改、删减一些做不到的或根据自身条件增加更多的验证</p>
<p>最后，别感冒<br><img src="images/117/P4iFQ1mqCnSGZfjhbHGLyBMqqVU3uplI0dbMS58Fgzg.png" srcset="/img/loading.gif" lazyload alt="image"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">

                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%BD%A6%E8%81%94%E7%BD%91/">车联网</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91/">车联网</a>
                    
                  </div>
                
              </div>
              <hr>
              <script src="https://utteranc.es/client.js"
        repo="novysodope/novysodope.github.io"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<hr>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/08/114/">
                        <span class="hidden-mobile">博客新增评论功能</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>


            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
