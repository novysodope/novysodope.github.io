

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="权限绕过细分">
<meta property="og:type" content="article">
<meta property="og:title" content="javaweb中的权限绕过">
<meta property="og:url" content="http://novysodope.github.io/2023/07/05/101/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="权限绕过细分">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/101/kZqRxWiEqF3dzEIPPrPNZNuIRpTzFs8WZXUSvfQkyzA.png">
<meta property="og:image" content="http://novysodope.github.io/images/101/qFnm4uzuwQQq96hGGSCetWW25VX5pMqLH7sVtxYqeGM.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/b3n-ZFEkR61QiHMwDm-IGgDGgNBpJIFZJO8EUK92IEI.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/QzCaXbS4clzoB95GCTiyyK9ppfh-Y7ZyLsRPIZpgjYM.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/iVhUoAqlhMeKtjSPAtHCit6TvoHpeHG5c4fY39zEkcs.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/KBwyxiTih4CwGs-kKBxMx2YYLhoXFZgKr9ERAhmkI34.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/sKjqyPEFDK6u3WQB783tykSJbEOuTrZ9lNRN-M6J7fA.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/p9KHxqUI6i_BT29GMP6R7ckO1JqnIANRJdzz9JSrRF8.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/aV94jcyftdGV8FbMPuHhLeJxdPKva6I6on1FELSFUtQ.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/_WJqFjCDUkcPz5k2VyZuu_kDTcm-ZQwO3pnk1AKlYqo.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/hfgv9bvOzH7N7Xp5aSBgmbPbs-brSpjHqoP0so-C_Fk.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/ybgGIiSHmJpMMLGcYJZq-3D0tIn8w5j_4DTM_W7xSkY.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/2_JPI8X5KKqZRGJsbf98AN6GVbO3NwWPEkix8OPkpfs.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/j7PdJHJQ7khLViyMSPNgxGGsOEGQNRWiRQH-bRAwZY4.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/hWXf1kE4EncSKraygDTyHjUcpbfC0rYJqBX7__JsCco.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/q6J8mRLyMrPadFojwTWmTvQzR5cg7IxDCf8TY06ZJEQ.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/m5SBIsfGkv1O8rHKyU1z_7i0bvzSnu0X3ZKpIVV3Als.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/WEpHL6PiKtIr_W60j8Yrse1-vlrIcgOXrDcdDTkjIJk.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/YNgxGtjjEe22Kehrnwkq27TseNwAbpmxfpjG4V-G1rY.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/AedKl0hCEhbG8hH6rJpf1ItCfRshMzh88F-1Xo5XbXY.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/2egnskh0i5TLHLPRVYkQE5gW98BmW-yESHwecyQ5-Co.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/CeZxNwXNQQGsU3jmdsMAm5UnsjJ2KezliuFzXTPpdLo.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/FhIDdvcj-ob3LE7dkVCn1p66aVtc9q3WAxGMyCIV2mI.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/4gksbWgiOS77w2aZetP3DpY3O_2C721qmRYCOL6rPeY.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/qD_cNE8orB-vMp2fvuEtaMQPH_FGQvtRgSDYF87JW_8.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/vFMA5VRuFYz3ZJYzdh9L3Q-7yzptmSwtUatGSVkuQew.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/pfk2cFvlYpLofvcJzepNn9ckNU9K-fdScWg97MwofMc.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/izQyhPp2UPQ_5nD5q_d-TfTF0wi8OFGn4Cxup0MYiG0.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/HDO8wXYLpcMRr9_HO40Kt8QK4d_zjzjzw-v79eflSH4.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/FZOaBih_8PaiB_aj6LeUaB0wylm5iQHrDk8aEYtkLqQ.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/MiThzWhwmzIUpZB-GCt3NoGKLNAk0pvevl_uFtpJpZM.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/gJPv63mp9rhrwe-8Qk00s3bTpf7daCCdmpVFSl2ufBU.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/1YMK50KLipVQKRn0IuYNmTBMC_ydvH1ZbKPe1I02eAo.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/ds9E-arLm9bq-MrstYz_xZ6fS9WNWpgxLLCnsFv2zbE.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/Nn_K5QWyv9b3DE9kaxp3YwGY51ICRfijhvKQHLrFPQk.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/aXMa2hhX0vNNNve08sSQ-FZBwrXVNwTn0wK1EoYCGuE.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/101/KGEvneoJpwvZooBw-TWpPU2A9nRoLA16eTcXYS0EIXw.jpg">
<meta property="article:published_time" content="2023-07-05T05:15:21.000Z">
<meta property="article:modified_time" content="2023-07-07T04:20:18.611Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/101/kZqRxWiEqF3dzEIPPrPNZNuIRpTzFs8WZXUSvfQkyzA.png">
  
  <title>javaweb中的权限绕过 - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="javaweb中的权限绕过">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-05 13:15" pubdate>
        July 5, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.5k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      11 分钟
    </span>
  

  
  
    

      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">javaweb中的权限绕过</h1>
            
            <div class="markdown-body">
              <h1 id="场景一：身份信息绕过"><a href="#场景一：身份信息绕过" class="headerlink" title="场景一：身份信息绕过"></a><strong>场景一：身份信息绕过</strong></h1><h2 id="案例一：Cookie伪造"><a href="#案例一：Cookie伪造" class="headerlink" title="案例一：Cookie伪造"></a><strong>案例一：Cookie伪造</strong></h2><h3 id="1、身份伪造"><a href="#1、身份伪造" class="headerlink" title="1、身份伪造"></a><strong>1、身份伪造</strong></h3><p>此类绕过主要关注user信息是否可以构造</p>
<p>查看filter</p>
<p><img src="/images/101/kZqRxWiEqF3dzEIPPrPNZNuIRpTzFs8WZXUSvfQkyzA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>首先查看byToken方法</p>
<p>获取参数token</p>
<p><img src="/images/101/qFnm4uzuwQQq96hGGSCetWW25VX5pMqLH7sVtxYqeGM.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在getDataFromToken方法中对token进行解析，得到第一个.前面的base64编码参数并进行解码</p>
<p><img src="/images/101/b3n-ZFEkR61QiHMwDm-IGgDGgNBpJIFZJO8EUK92IEI.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进cleanToken得出参数格式为base64编码的xxxx:xxxx（可能是多位），替换后变成xxx.xxxx</p>
<p><img src="/images/101/QzCaXbS4clzoB95GCTiyyK9ppfh-Y7ZyLsRPIZpgjYM.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在解析完token后就将其封装到LoginUserHolder对象，流程可以看到这里是直接绑定身份信息，没有其他认证，那么只要往下看参数的格式，想办法构造即可绕过</p>
<p><img src="/images/101/iVhUoAqlhMeKtjSPAtHCit6TvoHpeHG5c4fY39zEkcs.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>为了查看token的格式，跟进set方法</p>
<p><img src="/images/101/KBwyxiTih4CwGs-kKBxMx2YYLhoXFZgKr9ERAhmkI34.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>LoginUser对象类型的参数，跟进LoginUser即可得到参数并构造</p>
<p><img src="/images/101/sKjqyPEFDK6u3WQB783tykSJbEOuTrZ9lNRN-M6J7fA.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>id=1&amp;dlh=2&amp;name=3&amp;orgid=4&amp;org=5</p>
<p>将其base64编码即可作为token参数传递：</p>
<p>token: aWQ9MSZkbGg9MiZuYW1lPTMmb3JnaWQ9NCZvcmc9NQ==:xxxxxxx</p>
<p>再看bySession方法</p>
<p><img src="/images/101/p9KHxqUI6i_BT29GMP6R7ckO1JqnIANRJdzz9JSrRF8.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在decode方法中会先对参数做aes解密然后再使用json解析，由此得出参数是json格式，Aes密钥硬编码</p>
<p><img src="/images/101/aV94jcyftdGV8FbMPuHhLeJxdPKva6I6on1FELSFUtQ.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>这里比较简单，由于密钥硬编码，且知道了格式是json，直接用CipherUtil的加密方法对参数进行加密就行了，这个属于硬编码利用绕过</p>
<p><img src="/images/101/_WJqFjCDUkcPz5k2VyZuu_kDTcm-ZQwO3pnk1AKlYqo.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>KEY_USERHOLDER_INFO: aWQ9MSZkbGg9MiZuYW1lPTMmb3JnaWQ9NCZvcmc9NQ==</p>
<h3 id="2、密钥硬编码"><a href="#2、密钥硬编码" class="headerlink" title="2、密钥硬编码"></a><strong>2、密钥硬编码</strong></h3><p>此类绕过关注点在于认证时使用了jwt之类的加密token认证，然后加密密钥硬编码在了代码或配置文件里，利用的前提需要跟进认证实现查看，如果只判断了解密后不为空token就可以使用那就是存在漏洞可以利用，经典案例：<a target="_blank" rel="noopener" href="https://forum.butian.net/share/973">https://forum.butian.net/share/973</a> SpringBlade框架JWT认证缺陷漏洞、nacos硬编码漏洞</p>
<h2 id="案例二：Map的利用"><a href="#案例二：Map的利用" class="headerlink" title="案例二：Map的利用"></a><strong>案例二：Map的利用</strong></h2><p>此类绕过关注点在于put与get的条件判断。可以把attribute当成一个map集合，集合有k跟v两个参数，v是k的值。首先要了解假如是单纯的put，则属性是存在request域，request属性是一次性的。如果带上@SessionAttribute注解或者使用了getSession方法，就同时存在session域，session属性只有销毁或者重启才会失效，以下是attribute方法的利用</p>
<p> </p>
<p>首先看例子中（/index1）的判断，获取session域里user的属性是否为空，不为空就放行请求</p>
<p><img src="/images/101/hfgv9bvOzH7N7Xp5aSBgmbPbs-brSpjHqoP0so-C_Fk.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>这时候就可以查找user被set且可以未授权访问的地方，如图所示</p>
<p><img src="/images/101/ybgGIiSHmJpMMLGcYJZq-3D0tIn8w5j_4DTM_W7xSkY.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>当访问/index2时session域里就会写入一个user对象，访问请求会响应一个包含user信息的cookie</p>
<p><img src="/images/101/2_JPI8X5KKqZRGJsbf98AN6GVbO3NwWPEkix8OPkpfs.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>把cookie替换到请求，再访问一次index1，此时获取到的user不为空就会通过判断，放行请求</p>
<p><img src="/images/101/j7PdJHJQ7khLViyMSPNgxGGsOEGQNRWiRQH-bRAwZY4.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<h2 id="案例三：异常绕过"><a href="#案例三：异常绕过" class="headerlink" title="案例三：异常绕过"></a><strong>案例三：异常绕过</strong></h2><p>此类绕过是利用默认的布尔值以及catch模块的位置进行绕过</p>
<p>查看过滤器的实现，当buff返回true时就放行请求</p>
<p><img src="/images/101/hWXf1kE4EncSKraygDTyHjUcpbfC0rYJqBX7__JsCco.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>查看buff方法的实现，permi初始化是true</p>
<p><img src="/images/101/q6J8mRLyMrPadFojwTWmTvQzR5cg7IxDCf8TY06ZJEQ.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>注意此处try catch的位置</p>
<p><img src="/images/101/m5SBIsfGkv1O8rHKyU1z_7i0bvzSnu0X3ZKpIVV3Als.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在try里，请求传入Req2Json.parse做json解析，当解析异常时就会直接走到catch位置，然后返回布尔值，因为初始化是true，所以返回的也是true。所以这个时候再找一个文件上传的的请求，json解析异常时返回true即可进行绕过。</p>
<h2 id="案例四：前端认证绕过"><a href="#案例四：前端认证绕过" class="headerlink" title="案例四：前端认证绕过"></a><strong>案例四：前端认证绕过</strong></h2><p>此类关注点在于前端解析后端的响应包，利用响应状态来进行绕过</p>
<p> </p>
<p>查看登录实现，在loginAction方法中，只是对验证账号密码后做出响应内容的处理，没有进一步的操作实现，相当于点击登录只会提示成功或失败，没有其他动作</p>
<p><img src="/images/101/WEpHL6PiKtIr_W60j8Yrse1-vlrIcgOXrDcdDTkjIJk.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>但是实际登录却的确有跳转的动作，在代码中无法看到登录后跳转的处理代码</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">针对这个问题有三个思路：<br><span class="hljs-number">1</span>、其他认证类<span class="hljs-built_in">filter</span>对/*请求有专门的响应判断；<br><span class="hljs-number">2</span>、其他认证类<span class="hljs-built_in">filter</span>对/*请求有专门的cookie判断<br><span class="hljs-number">3</span>、其他地方有针对这个登录做专门的响应判断<br></code></pre></div></td></tr></table></figure>
<p>但找了所有过滤器都找不到1和2的实现，从第三点入手，在登录口查看源代码找登录相关的流程，发现原来是在前端做了响应判断</p>
<p><img src="/images/101/YNgxGtjjEe22Kehrnwkq27TseNwAbpmxfpjG4V-G1rY.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>解析后端返回的响应，当login字段的值是true时就会将账号密码设置成cookie的值然后跳转到后台管理页面，所以此处只需要抓包改响应包里的login值为true即可绕过
 </p>
<h1 id="场景二：配置绕过"><a href="#场景二：配置绕过" class="headerlink" title="场景二：配置绕过"></a><strong>场景二：配置绕过</strong></h1><h2 id="案例一：springboot-yml配置"><a href="#案例一：springboot-yml配置" class="headerlink" title="案例一：springboot yml配置"></a><strong>案例一：springboot yml配置</strong></h2><p>application.yml配置文件，有时候像图中有关拦截器的属性配置也可以利用，具体还是要看拦截器的实现。</p>
<p><img src="/images/101/AedKl0hCEhbG8hH6rJpf1ItCfRshMzh88F-1Xo5XbXY.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在拦截器中会获取URI进行判断，当符合条件就放行请求</p>
<p><img src="/images/101/2egnskh0i5TLHLPRVYkQE5gW98BmW-yESHwecyQ5-Co.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以请求结尾加上<code>;.jpg</code>等即可绕过，低版本的springboot还可以利用/admin/../绕过（要注意的是假如是低版本的springboot（小于等于2.3.0.RELEASE），则<code>/**</code>可以利用，否则springboot无法匹配到路由）</p>
<h2 id="案例二：排除绕过"><a href="#案例二：排除绕过" class="headerlink" title="案例二：排除绕过"></a><strong>案例二：排除绕过</strong></h2><h3 id="1、白名单利用"><a href="#1、白名单利用" class="headerlink" title="1、白名单利用"></a><strong>1、白名单利用</strong></h3><p>此类绕过主要关注当配置了某些请求是校验白名单时，可以从处理这些请求的Action中查找漏洞。</p>
<p>查看处理所有<code>.do</code>接口的过滤器</p>
<p><img src="/images/101/CeZxNwXNQQGsU3jmdsMAm5UnsjJ2KezliuFzXTPpdLo.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>doFilter判断登录状态</p>
<p><img src="/images/101/FhIDdvcj-ob3LE7dkVCn1p66aVtc9q3WAxGMyCIV2mI.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>isPermitAdmin方法：</p>
<p><img src="/images/101/4gksbWgiOS77w2aZetP3DpY3O_2C721qmRYCOL6rPeY.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>这些接口中都存在注入，找到对应的类即可看到详情</p>
<h3 id="2、filter绕过"><a href="#2、filter绕过" class="headerlink" title="2、filter绕过"></a><strong>2、filter绕过</strong></h3><p>此类绕过是按照web.xml中filter的定义来进行利用，当配置了映射时，处理了该映射的filter以及servlet没有对请求做校验就可以直接访问，与白名单利用的手法大同小异</p>
<h2 id="案例三：权限管理"><a href="#案例三：权限管理" class="headerlink" title="案例三：权限管理"></a><strong>案例三：权限管理</strong></h2><h3 id="1、第三方组件、框架"><a href="#1、第三方组件、框架" class="headerlink" title="1、第三方组件、框架"></a><strong>1、第三方组件、框架</strong></h3><p>此类关注是类似shiro、低版本框架等绕过。</p>
<p>需要注意的是在shiro中，@RequiresPermissions是用来分配用户角色权限的，接口会按照注解的值来决定哪个角色能访问当前请求，如图</p>
<p><img src="/images/101/qD_cNE8orB-vMp2fvuEtaMQPH_FGQvtRgSDYF87JW_8.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>当包含有该注解时，即使利用了<code>..;</code>也会无法绕过，因为<code>..;</code>时shiro获取到的attribute是anon，与注解的属性不匹配</p>
<p><img src="/images/101/vFMA5VRuFYz3ZJYzdh9L3Q-7yzptmSwtUatGSVkuQew.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以要找没有RequiresPermissions之类的角色分配注解的接口才可以进行利用。</p>
<h3 id="2、自定义注解"><a href="#2、自定义注解" class="headerlink" title="2、自定义注解"></a><strong>2、自定义注解</strong></h3><p>有时候开发会自己写权限注解接口@interface，但此类注解实现还是会依赖WebMvcConfigurer添加拦截器，拦截实现一般在Interceptor的preHandle方法，所以此类关注点可以看有没有加特别注解的controller（如果有低权限的账号可以查看注解相关属性，进行越权利用，也可以具体看注解的实现，看是否存在可利用的组合漏洞），或者看preHandle里有无可利用的点，如图</p>
<p><img src="/images/101/pfk2cFvlYpLofvcJzepNn9ckNU9K-fdScWg97MwofMc.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>对应的是开发自实现的一个接口，注意required是true</p>
<p><img src="/images/101/izQyhPp2UPQ_5nD5q_d-TfTF0wi8OFGn4Cxup0MYiG0.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>现在找项目的拦截器，全局搜Interceptor，在preHandle方法中可以看到对请求的处理</p>
<p><img src="/images/101/HDO8wXYLpcMRr9_HO40Kt8QK4d_zjzjzw-v79eflSH4.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>可以看到preHandle方法里用到了刚刚的接口做权限判断，当处理当前请求的业务逻辑中存在@PassTokenAnno就会跳过登录认证，进行未授权访问</p>
<p><img src="/images/101/FZOaBih_8PaiB_aj6LeUaB0wylm5iQHrDk8aEYtkLqQ.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<h2 id="其他："><a href="#其他：" class="headerlink" title="其他："></a><strong>其他：</strong></h2><p>利用类似hop by hop逐跳之类特性跟系统里其他部分组合起来进行绕过，参考 BIG-IP认证绕过漏洞</p>
<h1 id="场景三：过滤绕过"><a href="#场景三：过滤绕过" class="headerlink" title="场景三：过滤绕过"></a><strong>场景三：过滤绕过</strong></h1><h2 id="案例一：条件判断"><a href="#案例一：条件判断" class="headerlink" title="案例一：条件判断"></a><strong>案例一：条件判断</strong></h2><h3 id="1、以xx结尾判断"><a href="#1、以xx结尾判断" class="headerlink" title="1、以xx结尾判断"></a><strong>1、以xx结尾判断</strong></h3><p>此类绕过主要关注条件中以xx为结尾的利用</p>
<p>查看Filter条件判断，在获取到URI后进入条件</p>
<p><img src="/images/101/MiThzWhwmzIUpZB-GCt3NoGKLNAk0pvevl_uFtpJpZM.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>当url以静态资源为结尾时就放行请求，所以URL后面加上;.jpg即可绕过登录</p>
<h3 id="2、以包含xx判断"><a href="#2、以包含xx判断" class="headerlink" title="2、以包含xx判断"></a><strong>2、以包含xx判断</strong></h3><p>该类绕过关注点在于判断参数是否包含xxxx，或者是xxxx来进行绕过</p>
<p> </p>
<p>查看认证过滤器UserAuthenticationFilter类</p>
<p><img src="/images/101/gJPv63mp9rhrwe-8Qk00s3bTpf7daCCdmpVFSl2ufBU.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在过滤器中，初始化变量，将刚刚的白名单添加到fileTypeList</p>
<p><img src="/images/101/1YMK50KLipVQKRn0IuYNmTBMC_ydvH1ZbKPe1I02eAo.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在dofilter中使用了request.getRequestURI();来做校验，当请求url里包含有白名单字符就会放行请求</p>
<p><img src="/images/101/ds9E-arLm9bq-MrstYz_xZ6fS9WNWpgxLLCnsFv2zbE.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以只要在URL结尾加上;.xx即可绕过</p>
<h2 id="案例二：正则匹配判断"><a href="#案例二：正则匹配判断" class="headerlink" title="案例二：正则匹配判断"></a><strong>案例二：正则匹配判断</strong></h2><h3 id="1、匹配返回true"><a href="#1、匹配返回true" class="headerlink" title="1、匹配返回true"></a><strong>1、匹配返回true</strong></h3><p>此类绕过关注点是match的用法，当匹配到目标时就返回true的利用</p>
<p>查看filter</p>
<p><img src="/images/101/Nn_K5QWyv9b3DE9kaxp3YwGY51ICRfijhvKQHLrFPQk.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>antMatchs方法中，只要访问的url中出现白名单的值就能符合条件</p>
<p><img src="/images/101/aXMa2hhX0vNNNve08sSQ-FZBwrXVNwTn0wK1EoYCGuE.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>excludesAntMatch白名单</p>
<p><img src="/images/101/KGEvneoJpwvZooBw-TWpPU2A9nRoLA16eTcXYS0EIXw.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><code>/**</code>（包括<code>/**/*.*</code>）的均可利用</p>
<h3 id="3、matcher特性绕过"><a href="#3、matcher特性绕过" class="headerlink" title="3、matcher特性绕过"></a><strong>3、matcher特性绕过</strong></h3><p>此类关注点在于在Java中的正则默认情况下<code>.</code>并不包含<code>\r</code>和<code>\n</code>字符来进行利用，参考CVE-2022-32532/CVE-2022-22978</p>
<p> </p>
<p> </p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/02/100/">
                        <span class="hidden-mobile">PowerJob Remote Command/Code Execution</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
