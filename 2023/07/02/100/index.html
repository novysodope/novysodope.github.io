

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="PowerJob全版本RCE审计">
<meta property="og:type" content="article">
<meta property="og:title" content="PowerJob Remote Command&#x2F;Code Execution">
<meta property="og:url" content="http://novysodope.github.io/2023/07/02/100/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="PowerJob全版本RCE审计">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/99/o5z_FwKXzvnwzzam6CAfy6yo6t5s3OsVrfOnPTzEgtM.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/rXVI7l0HP6BB3M_t7AAJQBgBlHBTBx8CvVQHKiPLxtQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/fAmhwqCuTrdVvGHqGKrByefF4DAO8SwSKY3Imva5oUA.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/rgPOxmOxiC4-w06HhU-pgsnuOa_8Of7YqZ42QTzBdpo.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/aiqoHW4qnNBfDkdgPpAWcfIKqAQM9UAVXYULHI72eRA.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/9ERjIOBYwoBqTMWgIIfhch5xBUGmuEygw7_Q3WOWDk4.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/f4366pdLsBSPfO93M9EjEuzQ3UBiGj8gR8DEbVK9FE0.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/RSfbIOenMUptyfXLQCzuu-kwfd1EcClmMkaAwVZJ7Bo.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/Op1UdjsFJdvHYgkW5UT0xe93nvpblhu9vNTJyNLUrQE.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/M5E29ntyZ1aI68syFf4VsFE30QA3dxfL41W2tti_94I.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/r_cvNoi14O69sldMY1BaD2FmMvTc-lWy-eqS3DWhwBI.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/nFJJBpgefF8uesgu0u2JYw4UOnXhC9XnH3JlceW_Smw.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/CqbBr0UqhA28cOw6erogK-RPcBNzxuJYVwx8v38CLVc.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/pGdLPwHoWhHYOA6UTia53BAsslF5jBEs8gg9HNH4OPI.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/iqHGgwTEYfwHinPrsge7xciRTNrdfr2-MQ700IpkmYM.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/wVx3T96hJAnVbGhopt6Z4vMuY9kyDEOILeGiPo2WU6o.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/CcvkyaUO1B7H8ajuBgt326TR6f7RmLpq2i9ZLP4D6uI.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/7IfmcNlZ67RXPPCgK4jdOdUvbR4KxetDV5oQPyGJ1xo.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/WfBywAwMiUMVWyXF9NWzL15fdJv8CSVDf7uT4LRNjCQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/S6WHFAh1snUZ-Ho6KRiAkug7Xbluy_70PplUbIjfk64.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/LMP7MLIZYdxxwwMBFfrkiSHzKlWdKE0UOuLVaJo6aLE.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/fWcY4yQHj_0EVzihquGzZ7FL1I7cLQIDcJ6waiJOaPg.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/iaSFp6HoWgdnC5J9wnTuOXR-HQyz8NwEaT0CZ_BYO4.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/2a_6OAi_dOkNlzbv6cwfeWCBmX_DcFNl_V2jXNOUSgY.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/FoHnNt5nZewDKKfQWgsckLjRU0amt-u8nkjMywjDLHk.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/07xl9k69FGgwoTRME6gsoOdox0zj_-jENbekFDVnGOA.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/i7Ie1F2BYZwY8VV5MPWhIvrM7NMR_K4pO_FZQ3DCz20.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/NVavflV4Ekk9Of5eCMiUezddZex_1TI408lgJz3UXa8.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/0eJ5nx4fAdpZ-nabVZntMb7i9tlgH3cHEQctYOixgxk.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/DTfharPQeHvLm2lxaa6hMNUzpagfcgporCr7IK6WKFA.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/ry6LRdcXS7YWzvXIIeKoBtDMKz8BKxv5Ei7F8KOzLfE.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/F80vz9E9xRN7k8S_-l5VLViXwPCxes26tuqLkS7cBWk.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/buN2XWRZoXyK04LiPQ0Sb2Se-WLRVgyAeHf1Q9QQuAQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/WImONBAtVk7HWBONPNyCjFjPgVuI05Fh_SX4A73Eekg.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/loJ8Iw5x79AczXNPAZdPBZYny0lFmmV_wYgXPi_K6mo.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/1qoMlt7rpMEoeHJgQhbyphu6z7kqPZW1gJ8Iazn2r8c.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/ZJxPfgFNL8FKO84o_mpqtxbZRNgvSj9bXOxhK-Xep_Q.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/I8i9YYIMzXo_-3BM_T0D3aIdPl_wKcctBStRl0JMSD4.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/GXV_J9y4jdCxeZG698txsEUW8fNXyEA2kriV3-rXb2g.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/ClO0n3fnusO-SUyyLCQMuGAv9KemF8gSQ7uOVjuOHs0.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/99/6GuiG10XvZ8PC1YMT5OySsRZ214RS2SngDu-rUfF7bw.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/99/5HZCMurI5Nl9bS7tT03kNfAzsMrB2mf9fAw5LCx1qEY.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/99/SUaUqNXldMZhWK75tel9VlUCZCEhzzKUITeRBr02z78.jpg">
<meta property="og:image" content="http://novysodope.github.io/images/99/rKY5sfX7RwhMpBDfrqREo0iwGjSSRMEBOO4dLEJjN88.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/sh2XztQgfQkXa59C2U9jbmdczVmQmkJh38rz4rPunDo.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/cm5DLMiBDxxbcNfrcBSEFo0fojwjykAeJSu1n3ieRjQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/SUZVEelwT3BYErkVTXOIcyDBCNsR1J62MmkdUIOeqI4.png">
<meta property="og:image" content="http://novysodope.github.io/images/99/IJWP6bbNhMhnhCbFjzeesd7mXe916O_js2AfxAqDAck.png">
<meta property="article:published_time" content="2023-07-02T05:16:22.000Z">
<meta property="article:modified_time" content="2024-12-11T03:39:37.124Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/99/o5z_FwKXzvnwzzam6CAfy6yo6t5s3OsVrfOnPTzEgtM.png">
  
  <title>PowerJob Remote Command/Code Execution - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ZyJbAKYmfgJXZGNkDKKBRC0i-gzGzoHsz","app_key":"WXTmIgfHD2JkbhooWMtgYW3C","server_url":"https://zyjbakym.lc-cn-n1-shared.com","path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/rss2.xml" title="novy's Blog" type="application/rss+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/rss2.xml">
                <i class="iconfont icon-rss-fill"></i>
                RSS
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="PowerJob Remote Command/Code Execution">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-02 13:16" pubdate>
        July 2, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      9 分钟
    </span>
  

  
  
    

      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">PowerJob Remote Command/Code Execution</h1>
            
            <div class="markdown-body">
              <p>PowerJob本身没有鉴权网关，所以所有接口都可以未授权操作</p>
<p>首先看JobController的runImmediately方法负责执行任务，</p>
<p>任务调度的处理过程有点复杂，详情看</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42985872/article/details/128500740">https://blog.csdn.net/qq_42985872/article/details/128500740</a></p>
<p>定位到类：WorkerActor</p>
<p>onReceiveServerScheduleJobReq方法负责处理runjob节点的请求。此时空属性的ServerScheduleJobReq对象会传递进入下一级onReceiveServerScheduleJobReq方法</p>
<p><img src="/images/99/o5z_FwKXzvnwzzam6CAfy6yo6t5s3OsVrfOnPTzEgtM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>onReceiveServerScheduleJobReq方法会根据任务类型进入不同的处理，轻量级任务进入LightTaskTracker</p>
<p><img src="/images/99/rXVI7l0HP6BB3M_t7AAJQBgBlHBTBx8CvVQHKiPLxtQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>而重量级任务则会进入HeavyTaskTracker</p>
<p><img src="/images/99/fAmhwqCuTrdVvGHqGKrByefF4DAO8SwSKY3Imva5oUA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进isLightweightTask方法查看如何判断的级别</p>
<p><img src="/images/99/rgPOxmOxiC4-w06HhU-pgsnuOa_8Of7YqZ42QTzBdpo.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>从isLightweightTask方法得知，单机、固定频率、固定延迟模式都属于轻量，其他则是重量</p>
<p>先跟进轻量，LightTaskTracker#create</p>
<p><img src="/images/99/aiqoHW4qnNBfDkdgPpAWcfIKqAQM9UAVXYULHI72eRA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>请求传进LightTaskTracker对象：</p>
<p><img src="/images/99/9ERjIOBYwoBqTMWgIIfhch5xBUGmuEygw7_Q3WOWDk4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在构造方法中做了大量的初始化设定，具体为：会使用父类对请求先做一次参数初始化</p>
<p><img src="/images/99/f4366pdLsBSPfO93M9EjEuzQ3UBiGj8gR8DEbVK9FE0.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>此时的req是包含有控制台传来的各项参数，继续往下走，constructTaskContext方法会将各项参数封装到taskContext对象</p>
<p><img src="/images/99/RSfbIOenMUptyfXLQCzuu-kwfd1EcClmMkaAwVZJ7Bo.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/99/Op1UdjsFJdvHYgkW5UT0xe93nvpblhu9vNTJyNLUrQE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>随后进入到load方法加载控制台传来的ProcessorInfo</p>
<p><img src="/images/99/M5E29ntyZ1aI68syFf4VsFE30QA3dxfL41W2tti_94I.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在PowerJobProcessorLoader#load方法中，ProcessorInfo信息又被传进pf.build方法</p>
<p><img src="/images/99/r_cvNoi14O69sldMY1BaD2FmMvTc-lWy-eqS3DWhwBI.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>pf是包含 BuiltInDefaultProcessorFactory、JarContainerProcessorFactory的对象</p>
<p><img src="/images/99/nFJJBpgefF8uesgu0u2JYw4UOnXhC9XnH3JlceW_Smw.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在load流程里，会根据传进的处理器类型进入不同的Factory</p>
<p><img src="/images/99/CqbBr0UqhA28cOw6erogK-RPcBNzxuJYVwx8v38CLVc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>得到处理器参数：BUILT_IN、EXTERNAL</p>
<p><img src="/images/99/pGdLPwHoWhHYOA6UTia53BAsslF5jBEs8gg9HNH4OPI.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>分别查看两个Factory</p>
<p>JarContainerProcessorFactory：</p>
<p>根据注释得知该类是从容器加载class，从传进的参数中获取容器id以及容器里的全限定类名，格式大概是这样id#xx.xxx.xxx，当processorType是EXTERNAL时就会用到这个Factory</p>
<p><img src="/images/99/iqHGgwTEYfwHinPrsge7xciRTNrdfr2-MQ700IpkmYM.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>BuiltInDefaultProcessorFactory：</p>
<p>BuiltInDefaultProcessorFactory是内建的默认处理器工厂，可以通过全限定类名加载处理器，在build方法中，会根据传进的ProcessorInfo信息来实例化对象，即ProcessorInfo参数就是全限定类名。当processorType是BUILT_IN时就会用到这个Factory</p>
<p><img src="/images/99/wVx3T96hJAnVbGhopt6Z4vMuY9kyDEOILeGiPo2WU6o.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>load方法走完了，回到构造方法LightTaskTracker中，实例化后的ProcessorInfo信息被封装到processorBean对象</p>
<p><img src="/images/99/CcvkyaUO1B7H8ajuBgt326TR6f7RmLpq2i9ZLP4D6uI.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/99/7IfmcNlZ67RXPPCgK4jdOdUvbR4KxetDV5oQPyGJ1xo.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在初始化完所有信息后，进入到processTask方法，其会在线程池中完成被调用</p>
<p><img src="/images/99/WfBywAwMiUMVWyXF9NWzL15fdJv8CSVDf7uT4LRNjCQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进processTask方法，参数传进process</p>
<p><img src="/images/99/S6WHFAh1snUZ-Ho6KRiAkug7Xbluy_70PplUbIjfk64.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>因为在此之前设置了当前线程上下文加载器</p>
<p><img src="/images/99/LMP7MLIZYdxxwwMBFfrkiSHzKlWdKE0UOuLVaJo6aLE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以此时被实例化的processorBean会使用到前面实例化时设置的classloader加载</p>
<p><img src="/images/99/fWcY4yQHj_0EVzihquGzZ7FL1I7cLQIDcJ6waiJOaPg.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>进入到</p>
<p>CommonBasicProcessor#process</p>
<p>该类是一个通用处理器类</p>
<p><img src="/images/99/iaSFp6HoWgdnC5J9wnTuOXR-HQyz8NwEaT0CZ_BYO4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>process方法中，将包含有任务参数、任务instanceId等信息的TaskContext对象传进process0方法</p>
<p><img src="/images/99/2a_6OAi_dOkNlzbv6cwfeWCBmX_DcFNl_V2jXNOUSgY.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/99/FoHnNt5nZewDKKfQWgsckLjRU0amt-u8nkjMywjDLHk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>process0方法属于AbstractScriptProcessor类，该类属于通用脚本处理器类，所有脚本插件都要继承该类。在process0方法中，会使用prepareScriptFile方法来根据控制台传来的内容生成脚本文件，文件名是instanceId</p>
<p><img src="/images/99/07xl9k69FGgwoTRME6gsoOdox0zj_-jENbekFDVnGOA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/99/i7Ie1F2BYZwY8VV5MPWhIvrM7NMR_K4pO_FZQ3DCz20.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进getScriptName方法发现是一个抽象方法</p>
<p><img src="/images/99/NVavflV4Ekk9Of5eCMiUezddZex_1TI408lgJz3UXa8.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所在的抽象类由多个插件类继承，用于应对不同系统的调用。在powerjob本身中自带有多个脚本处理器（插件）</p>
<p><img src="/images/99/0eJ5nx4fAdpZ-nabVZntMb7i9tlgH3cHEQctYOixgxk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>被重写的getScriptName方法大同小异，均返回对应系统的脚本文件名：cmd_instanceId.bat/shell_instanceId.sh</p>
<p><img src="/images/99/DTfharPQeHvLm2lxaa6hMNUzpagfcgporCr7IK6WKFA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/99/ry6LRdcXS7YWzvXIIeKoBtDMKz8BKxv5Ei7F8KOzLfE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>回到prepareScriptFile方法，最终把参数写入脚本文件</p>
<p><img src="/images/99/F80vz9E9xRN7k8S_-l5VLViXwPCxes26tuqLkS7cBWk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>回到process0方法，方法里会调用到抽象方法getRunCommand，根据子类重写的方法返回来判断要调用哪个应用来执行脚本。</p>
<p>也就是说，当控制台传进的processorInfo（即封装后的processorBean）是CMDProcessor类时，getRunCommand则是CMDProcessor里重写的getRunCommand方法，返回的是cmd.exe，否则就是剩余的几个Processor（python、sh、powershell）</p>
<p><img src="/images/99/buN2XWRZoXyK04LiPQ0Sb2Se-WLRVgyAeHf1Q9QQuAQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>最终由ProcessBuilder完成对getRunCommand方法返回值的调用，scriptPath被当成返回值的参数进行执行。漏洞由此产生</p>
<p>剩下的HeavyTaskTracker.create不看了，可能更复杂</p>
<h1 id="验证："><a href="#验证：" class="headerlink" title="验证："></a>验证：</h1><p>根据saveJob方法里jobInfoDO的信息构造参数保存任务，其中jobParams参数是恶意命令，最后使用runImmediately方法执行任务就会触发漏洞</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">src/main/java/tech/powerjob/server/web/controller/JobController.java<br></code></pre></div></td></tr></table></figure>
<p>保存任务</p>
<p><img src="/images/99/WImONBAtVk7HWBONPNyCjFjPgVuI05Fh_SX4A73Eekg.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>查看实体类，可以看到有一个处理器选项</p>
<figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Plain">SaveJobInfoRequest<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/99/loJ8Iw5x79AczXNPAZdPBZYny0lFmmV_wYgXPi_K6mo.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Plain">ProcessorType类<br></code></pre></div></td></tr></table></figure>
<p><img src="/images/99/1qoMlt7rpMEoeHJgQhbyphu6z7kqPZW1gJ8Iazn2r8c.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h2 id="V3-X及以前"><a href="#V3-X及以前" class="headerlink" title="V3.X及以前"></a>V3.X及以前</h2><p>在V3及以前版本中可以直接通过shell处理器的方式执行系统命令，但仅限于linux</p>
<p><img src="/images/99/ZJxPfgFNL8FKO84o_mpqtxbZRNgvSj9bXOxhK-Xep_Q.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/99/I8i9YYIMzXo_-3BM_T0D3aIdPl_wKcctBStRl0JMSD4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>新建任务时，designatedWorkers可指定机器，不指定机器默认全部执行</p>
<p>可以查看所有机器地址</p>
<p><img src="/images/99/GXV_J9y4jdCxeZG698txsEUW8fNXyEA2kriV3-rXb2g.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>processorInfo的参数为命令执行参数</p>
<p><img src="/images/99/ClO0n3fnusO-SUyyLCQMuGAv9KemF8gSQ7uOVjuOHs0.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>搜索刚刚创建的任务关键字得出任务id</p>
<p><img src="/images/99/6GuiG10XvZ8PC1YMT5OySsRZ214RS2SngDu-rUfF7bw.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>运行任务id得到结果id</p>
<p><img src="/images/99/5HZCMurI5Nl9bS7tT03kNfAzsMrB2mf9fAw5LCx1qEY.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>根据id获取命令执行结果</p>
<p><img src="/images/99/SUaUqNXldMZhWK75tel9VlUCZCEhzzKUITeRBr02z78.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<h2 id="V4-X"><a href="#V4-X" class="headerlink" title="V4.X"></a>V4.X</h2><p>v4以后的处理器都是通过插件的方式调用，此时双系统都可以执行命令</p>
<p><img src="/images/99/rKY5sfX7RwhMpBDfrqREo0iwGjSSRMEBOO4dLEJjN88.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h3 id="windows："><a href="#windows：" class="headerlink" title="windows："></a>windows：</h3><p>通过内置的全限定类名执行</p>
<p>保存任务后，查询任务id</p>
<p><img src="/images/99/sh2XztQgfQkXa59C2U9jbmdczVmQmkJh38rz4rPunDo.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>运行得到的id</p>
<p><img src="/images/99/cm5DLMiBDxxbcNfrcBSEFo0fojwjykAeJSu1n3ieRjQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h3 id="linux："><a href="#linux：" class="headerlink" title="linux："></a>linux：</h3><p>ShellProcessor</p>
<h3 id="python"><a href="#python" class="headerlink" title="python:"></a>python:</h3><p>PythonProcessor<br>该脚本处理器专门处理python_%d.py，可以往py里写入任意代码执行，但需要环境有python环境</p>
<h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell:"></a>powershell:</h3><p>PowerShellProcessor</p>
<p>以上都可以通过查询执行成功响应的id来查看命令回显</p>
<p><img src="/images/99/SUZVEelwT3BYErkVTXOIcyDBCNsR1J62MmkdUIOeqI4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h1 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h1><p>假如通过v3的方式在v4增加了任务，可以尝试通过接口转换执行</p>
<p><img src="/images/99/IJWP6bbNhMhnhCbFjzeesd7mXe916O_js2AfxAqDAck.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>但需要目标有这个依赖</p>
<figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Plain">&lt;dependency&gt;<br>    &lt;groupId&gt;tech.powerjob&lt;&#x2F;groupId&gt;<br>    &lt;artifactId&gt;powerjob-official-processors&lt;&#x2F;artifactId&gt;<br>    &lt;version&gt;4.3.3&lt;&#x2F;version&gt;<br>&lt;&#x2F;dependency&gt;<br></code></pre></div></td></tr></table></figure>





























            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">

                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
              </div>
              <hr>
              <script src="https://utteranc.es/client.js"
        repo="novysodope/novysodope.github.io"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<hr>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/03/112/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">代码审计快速入门2023修改版</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/18/107/">
                        <span class="hidden-mobile">一个bsh任意代码执行</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>


            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
