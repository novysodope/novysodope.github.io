

<!DOCTYPE html>
<html lang="" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Nevado JMS 审计记录">
<meta property="og:type" content="article">
<meta property="og:title" content="Nevado JMS反序列化审计tips">
<meta property="og:url" content="http://novysodope.github.io/2023/04/01/95/index.html">
<meta property="og:site_name" content="novy&#39;s Blog">
<meta property="og:description" content="Nevado JMS 审计记录">
<meta property="og:locale">
<meta property="og:image" content="http://novysodope.github.io/images/95/n5uan030E3squUEvxTctmwQeQpDvDUB1BlEoRDhB6vQ.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/xnH6iGAC0yvy6THveI21YWLua_zJn-1jZMpxYHF2tnc.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/Jxnd3vfAi34OZXAqI8xHhWGe_Wohh77OCSvN8T2Bxak.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/mXdksqi6P84SXEO-UuWwCnw7vcdxQwL9fZV9FmjLv-U.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/mfOQnN-w1A4Cp--i-Ng63qwQVqR8fI-4TucYyO_KEOE.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/29l4kptjFARpBUqRYYs8cXvFR7q6-IjQjZPGbjQKu3c.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/7Bxc8PyIauEMLNRbtFYxCLkAwndg4MC5VOtPP1zZAlw.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/7o1VEutT7qU6-ayLw2yVpI1x5QxiE28yjOhkYxFq6NY.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/dYjClZYULh0Nb4fc18Sxzkjaygc5VtWAw8QAMaftuPU.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/Avebnrrt-1wr8D1r2oEnrC6zSWOn2fx-2CH1Vb4s0lA.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/nuWRNyfPY9wtr4FUeaqUuL5SBQJ3QPtBRtd-ZGU5LKg.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/uByCmo06u-45PZzjiLe7gpc9ub3Cq12INwJmPccshSc.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/vJm-nWbxvWfRDFAEsF-_dwncibyYyQLITBTaTcir7zA.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/MQoWbOKrt4S9yqzmGj0Kf8rDH3_1gaO7qqrY5alUL_o.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/6XEVsyUVWM0-zLGZDlymMwtXw8gVG0AHdKY17278BJ8.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/ChN_NNHqnyvVNCO9pn4hG4L4SsCv7_hf1SuUPb-wED4.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/Bia_zCUogPPNtCWWbciSbZIE3nRYtJehtm6AUDPBw6k.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/4RCqjTKj0a3hENBuqX4h-IVz36JX4jvxv__6p4gm7wU.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/WFEMzAOh3LhlAilQqxRiu81HX466tIZ4gmGE_1qCy3o.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/841TCMHHobqgtPAJ6iKYTQbYHgkb5hYGsM1GE5iEU4E.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/GfLivifAmarYYuEaT8J_JFUP3Q58ey6ayz_YIxX5X2U.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/lwQATXcGna5Hvxq3F3tuXcbGr5NaqMaplRkME4LfikA.png">
<meta property="og:image" content="http://novysodope.github.io/images/95/2sgdNydTmydgrLRpddf8Mmjn-DzaSnukVyDAD22hcmk.png">
<meta property="article:published_time" content="2023-04-01T05:15:21.000Z">
<meta property="article:modified_time" content="2024-09-22T10:18:30.296Z">
<meta property="article:author" content="novy">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://novysodope.github.io/images/95/n5uan030E3squUEvxTctmwQeQpDvDUB1BlEoRDhB6vQ.png">
  
  <title>Nevado JMS反序列化审计tips - novy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"novysodope.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6,h7,h8,h9","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a6c1581442f57290135c4581f8de49ff","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ZyJbAKYmfgJXZGNkDKKBRC0i-gzGzoHsz","app_key":"WXTmIgfHD2JkbhooWMtgYW3C","server_url":"https://zyjbakym.lc-cn-n1-shared.com","path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>novy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Nevado JMS反序列化审计tips">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      novy
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-04-01 13:15" pubdate>
        April 1, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      13 分钟
    </span>
  

  
  
    

      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Nevado JMS反序列化审计tips</h1>
            
            <div class="markdown-body">
              <blockquote>
<p><a target="_blank" rel="noopener" href="http://nevado.skyscreamer.org/">http://nevado.skyscreamer.org/</a></p>
</blockquote>
<blockquote>
<p>Nevado JMS 是 Amazon SQS 的 JMS 驱动程序</p>
</blockquote>
<h1 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a><strong>流程分析</strong></h1><p>按照文档写一个消息接收</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        NevadoConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> NevadoConnectionFactory();<br>        NevadoConnection connection = connectionFactory.createConnection();<br>        NevadoSession session = connection.createSession(<span class="hljs-keyword">false</span>, NevadoSession.AUTO_ACKNOWLEDGE);<br>        NevadoQueue queue = session.createQueue(<span class="hljs-string">&quot;test&quot;</span>);<br>        NevadoMessageConsumer consumer = session.createConsumer(queue);<br>        NevadoMessage message = consumer.receive();<br>        <span class="hljs-comment">//        if (message instanceof TextMessage) &#123;</span><br>        <span class="hljs-comment">//            TextMessage textMessage = (TextMessage) message;</span><br>        <span class="hljs-comment">//            System.out.println(&quot;Received message: &quot; + textMessage.getText());</span><br>        <span class="hljs-comment">//        &#125;        </span><br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>


<p>在上面的流程中，会创建一个test队列传到receive方法，具体为：</p>
<p>队列“test”传进createConsumer方法，在createConsumer方法时被传递进了NevadoMessageConsumer对象</p>
<p><img src="/images/95/n5uan030E3squUEvxTctmwQeQpDvDUB1BlEoRDhB6vQ.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在构造函数NevadoMessageConsumer中，因为传进的是queque类型，所以会进入else，此时<code>_destination</code>就是队列test</p>
<p><img src="/images/95/xnH6iGAC0yvy6THveI21YWLua_zJn-1jZMpxYHF2tnc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>回到消息接收中，receive()方法会监听队列，从队列中接收消息</p>
<p><img src="/images/95/Jxnd3vfAi34OZXAqI8xHhWGe_Wohh77OCSvN8T2Bxak.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>继续跟进getUnfilteredMessage方法查看实现流程</p>
<p><img src="/images/95/mXdksqi6P84SXEO-UuWwCnw7vcdxQwL9fZV9FmjLv-U.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>getUnfilteredMessage方法是过滤被消费的消息，如果接收模式是2，就会先从缓存读取</p>
<p><img src="/images/95/mfOQnN-w1A4Cp--i-Ng63qwQVqR8fI-4TucYyO_KEOE.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>当不满足条件时就会调用<code>this._connection.getSQSConnector().receiveMessage</code>来接收队列消息，然后再将被接收过的消息添加到缓存中</p>
<p><img src="/images/95/29l4kptjFARpBUqRYYs8cXvFR7q6-IjQjZPGbjQKu3c.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>具体为：</p>
<p>已知初始化时<code>_connection</code>是NevadoConnection对象</p>
<p><img src="/images/95/7Bxc8PyIauEMLNRbtFYxCLkAwndg4MC5VOtPP1zZAlw.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/95/7o1VEutT7qU6-ayLw2yVpI1x5QxiE28yjOhkYxFq6NY.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>getSQSConnector方法返回的是SQSConnector</p>
<p><img src="/images/95/dYjClZYULh0Nb4fc18Sxzkjaygc5VtWAw8QAMaftuPU.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p><img src="/images/95/Avebnrrt-1wr8D1r2oEnrC6zSWOn2fx-2CH1Vb4s0lA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>这个接口封装了 Amazon SQS 相关的 API 调用，receiveMessage方法是接收消息</p>
<p><img src="/images/95/nuWRNyfPY9wtr4FUeaqUuL5SBQJ3QPtBRtd-ZGU5LKg.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>所以从代码分析，当不满足条件时，就会接收从Amazon SQS发送的队列消息</p>
<p><img src="/images/95/uByCmo06u-45PZzjiLe7gpc9ub3Cq12INwJmPccshSc.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进实现receiveMessage方法的实现类</p>
<p>在receiveMessage方法中，会将取出的队列传进receiveSQSMessage方法进一步接收队列中的消息</p>
<p><img src="/images/95/vJm-nWbxvWfRDFAEsF-_dwncibyYyQLITBTaTcir7zA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进receiveSQSMessage方法</p>
<p><img src="/images/95/MQoWbOKrt4S9yqzmGj0Kf8rDH3_1gaO7qqrY5alUL_o.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>此时receiveSQSMessage方法返回的就是test里面的消息，返回receiveMessage</p>
<p><img src="/images/95/6XEVsyUVWM0-zLGZDlymMwtXw8gVG0AHdKY17278BJ8.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>接收到队列消息后，将消息等参数传进convertSqsMessage方法</p>
<p><img src="/images/95/ChN_NNHqnyvVNCO9pn4hG4L4SsCv7_hf1SuUPb-wED4.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在convertSqsMessage方法中，会根据传进的destination类型来做不同的消息取出动作</p>
<p><img src="/images/95/Bia_zCUogPPNtCWWbciSbZIE3nRYtJehtm6AUDPBw6k.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>随后将取出的消息传进deserializeMessage方法做反序列化</p>
<p><img src="/images/95/4RCqjTKj0a3hENBuqX4h-IVz36JX4jvxv__6p4gm7wU.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>跟进deserializeFromString</p>
<p><img src="/images/95/WFEMzAOh3LhlAilQqxRiu81HX466tIZ4gmGE_1qCy3o.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>在deserializeFromString方法中，会对传进的消息做一次base64解码操作，然后再使用Hessian2Input对象进行反序列化。</p>
<p>根据代码的流程，如果要进行漏洞利用，acknowledgeMode就必须不等于2且transacted是false才能进入else走到反序列化功能，如开头所写，NevadoSession的模式分为4种：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">int</span> AUTO_ACKNOWLEDGE = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">int</span> CLIENT_ACKNOWLEDGE = <span class="hljs-number">2</span>;<br><span class="hljs-keyword">int</span> DUPS_OK_ACKNOWLEDGE = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">int</span> SESSION_TRANSACTED = <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure>
<p>且因为反序列化使用的是Hessian2Input，所以得知序列化的数据得是Hessian格式</p>
<p>该组件提供了一个反序列化工具类SerializeUtil.class，可以直接用来序列化恶意数据</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">serializeToString</span><span class="hljs-params">(Serializable serializable)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>    <span class="hljs-keyword">byte</span>[] data = serialize(serializable);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(Base64.encodeBase64(data));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] serialize(Serializable serializable) <span class="hljs-keyword">throws</span> IOException &#123;<br>    ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>    Hessian2Output hessian2Output = <span class="hljs-keyword">new</span> Hessian2Output(byteArrayOutputStream);<br>    hessian2Output.setSerializerFactory(<span class="hljs-keyword">new</span> SerializerFactory(SerializeUtil.class.getClassLoader()));<br>    hessian2Output.startMessage();<br>    <span class="hljs-keyword">if</span> (serializable <span class="hljs-keyword">instanceof</span> Character) &#123;<br>        serializable = <span class="hljs-keyword">new</span> CharWrapper((Character)serializable);<br>    &#125;<br><br>    hessian2Output.writeObject(serializable);<br>    hessian2Output.completeMessage();<br>    hessian2Output.close();<br></code></pre></div></td></tr></table></figure>


<h1 id="漏洞验证："><a href="#漏洞验证：" class="headerlink" title="漏洞验证："></a><strong>漏洞验证：</strong></h1><h2 id="方式一、本地部署验证"><a href="#方式一、本地部署验证" class="headerlink" title="方式一、本地部署验证"></a><strong>方式一、本地部署验证</strong></h2><p>发送消息的客户端，destination类型是queque</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Appclient</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> JMSException </span>&#123;<br>        <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        NevadoConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> NevadoConnectionFactory();<br>        NevadoConnection connection = connectionFactory.createConnection();<br><span class="hljs-comment">//false和1</span><br>        NevadoSession session = connection.createSession(<span class="hljs-keyword">false</span>, NevadoSession.AUTO_ACKNOWLEDGE);<br>        NevadoQueue queue = session.createQueue(<span class="hljs-string">&quot;test&quot;</span>);<br>        NevadoMessageProducer producer = session.createProducer(queue);<br><span class="hljs-comment">//如果destination类型是topic，那就是&#123;&quot;Message&quot;:&quot;base64编码后的恶意数据&quot;&#125;</span><br>        NevadoMessage message = session.createTextMessage(<span class="hljs-string">&quot;base64编码后的恶意数据&quot;</span>);<br>        producer.send(message);<br>        connection.close();<br><br>    &#125;<br></code></pre></div></td></tr></table></figure>
<p>接收消息：</p>
<p><img src="/images/95/841TCMHHobqgtPAJ6iKYTQbYHgkb5hYGsM1GE5iEU4E.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<h2 id="方式二、搭配amazon-sqs使用验证（没用过，理论是这样）"><a href="#方式二、搭配amazon-sqs使用验证（没用过，理论是这样）" class="headerlink" title="方式二、搭配amazon sqs使用验证（没用过，理论是这样）"></a><strong>方式二、搭配amazon sqs使用验证（没用过，理论是这样）</strong></h2><p>注册一个amazon，使用sqs服务</p>
<p><img src="/images/95/GfLivifAmarYYuEaT8J_JFUP3Q58ey6ayz_YIxX5X2U.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>然后发送消息</p>
<p><img src="/images/95/lwQATXcGna5Hvxq3F3tuXcbGr5NaqMaplRkME4LfikA.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>或者</p>
<p><img src="/images/95/2sgdNydTmydgrLRpddf8Mmjn-DzaSnukVyDAD22hcmk.png" srcset="/img/loading.gif" lazyload alt="image"></p>
<p>集群在接收消息后就会触发</p>
<h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a><strong>结尾</strong></h1><p>在跟进的时候还发现了亚马逊接收消息有一个getObject，应该也是个反序列化的点，后来搜网上有文章，属于是nday这里就不继续说了</p>
<p>Maven依赖</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">&lt;dependency&gt;<br>  &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;<br>  &lt;artifactId&gt;aws-java-sdk&lt;/artifactId&gt;<br>  &lt;version&gt;1.11.31&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>  &lt;groupId&gt;org.skyscreamer&lt;/groupId&gt;<br>  &lt;artifactId&gt;nevado-jms&lt;/artifactId&gt;<br>  &lt;version&gt;1.3.2&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></div></td></tr></table></figure>


<p> </p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">

                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                  </div>
                
              </div>
              <hr>
              <script src="https://utteranc.es/client.js"
        repo="novysodope/novysodope.github.io"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<hr>
              
                <p class="note note-warning">
                  
                    声明：<br>   本文章用于学习交流，严禁用于非法操作，出现后果一切自行承担，阅读此文章表示你已同意本声明。<br> <br> Disclaimer: <br>   This article is for study and communication. It is strictly forbidden to use it for illegal operations. All consequences shall be borne by yourself. Reading this article means that you have agreed to this statement.
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/18/107/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">一个bsh任意代码执行</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/22/106/">
                        <span class="hidden-mobile">两个审计记录</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>


            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="/img/aa.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;"><p></p> <p style="text-align:center"><span>扫一扫关注我们</span></p>
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     © 2018-<script type="text/javascript">document.write(new Date().getFullYear());</script> <span> <a href="#" target="_blank" rel="nofollow noopener"><font color="#2ca6cb">novy`s Blog</font>.</a> </span> Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><font color="#2ca6cb">Hexo</font></span></a><p><script> function secondToDate(second) { if (!second) { return 0; } var time = new Array(0, 0, 0, 0, 0); if (second >= 365 * 24 * 3600) { time[0] = parseInt(second / (365 * 24 * 3600)); second %= 365 * 24 * 3600; } if (second >= 24 * 3600) { time[1] = parseInt(second / (24 * 3600)); second %= 24 * 3600; } if (second >= 3600) { time[2] = parseInt(second / 3600); second %= 3600; } if (second >= 60) { time[3] = parseInt(second / 60); second %= 60; } if (second > 0) { time[4] = second; } return time; }</script> <script type="text/javascript" language="javascript"> function setTime() { var create_time = Math.round(new Date(Date.UTC(2018, 11, 09, 6, 6, 6)).getTime() / 1000); var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000); currentTime = secondToDate((timestamp - create_time)); currentTimeHtml = currentTime[0] + "年" + currentTime[1] + "天" + currentTime[2] + "时" + currentTime[3] + "分" + currentTime[4] + "秒"; document.getElementById("htmer_time").innerHTML = currentTimeHtml; }    setInterval(setTime, 1000);</script> 本博客已经稳定运行：<span id="htmer_time" style="color: #2ca6cb;"></span> <br/> <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

你是第<font color="#2ca6cb"><span id="busuanzi_value_site_uv"></span></font>个小伙伴 </p> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a6c1581442f57290135c4581f8de49ff";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  






<script  src="/js/boot.js" ></script>


</body>
</html>
